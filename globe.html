<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SENTINEL GLOBE</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%; overflow: hidden;
  background: #000;
  font-family: 'Courier New', monospace;
}

#cesiumContainer {
  width: 100%; height: 100vh;
  position: relative;
}

/* Override Cesium default UI */
.cesium-widget-credits { display: none !important; }
.cesium-viewer-toolbar { top: 44px !important; right: 8px !important; }
.cesium-viewer-animationContainer { display: none !important; }
.cesium-viewer-timelineContainer { display: none !important; }
.cesium-viewer-bottom { display: none !important; }

/* â”€â”€ Top Bar â”€â”€ */
#topbar {
  position: fixed;
  top: 0; left: 0; right: 0; height: 40px;
  background: rgba(0,0,0,0.9);
  border-bottom: 1px solid #FF6600;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
  backdrop-filter: blur(4px);
}
#topbar .logo {
  color: #FF6600;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 3px;
}
#topbar .status {
  display: flex;
  gap: 16px;
  font-size: 10px;
  color: #555;
  letter-spacing: 1px;
}
#topbar .status .live {
  color: #00CC44;
  display: flex;
  align-items: center;
  gap: 5px;
}
#live-dot {
  width: 6px; height: 6px;
  background: #00CC44;
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* â”€â”€ Left Panel â”€â”€ */
#left-panel {
  position: fixed;
  top: 40px; left: 0; bottom: 0;
  width: 220px;
  background: rgba(0,0,0,0.88);
  border-right: 1px solid #1A1A1A;
  z-index: 50;
  overflow-y: auto;
  padding: 12px;
  backdrop-filter: blur(8px);
}
.panel-section {
  margin-bottom: 16px;
}
.panel-title {
  color: #FF6600;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  border-bottom: 1px solid #1A1A1A;
  padding-bottom: 5px;
  margin-bottom: 8px;
}
.filter-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 8px;
  margin: 2px 0;
  cursor: pointer;
  border-radius: 2px;
  font-size: 10px;
  color: #888;
  letter-spacing: 1px;
  transition: all 0.15s;
  border: 1px solid transparent;
}
.filter-btn:hover { background: rgba(255,102,0,0.1); color: #FF8C00; }
.filter-btn.active {
  background: rgba(255,102,0,0.15);
  border-color: #FF6600;
  color: #FF8C00;
}
.filter-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.theater-item {
  padding: 5px 8px;
  margin: 2px 0;
  border-left: 2px solid transparent;
  font-size: 10px;
  color: #666;
  cursor: pointer;
  transition: all 0.15s;
}
.theater-item:hover { color: #FF8C00; background: rgba(255,102,0,0.05); }
.theater-item.critical { border-left-color: #FF0000; }
.theater-item.active   { border-left-color: #FF6600; }
.theater-item.elevated { border-left-color: #FFAA00; }
.theater-item.monitor  { border-left-color: #FFFF00; }

.event-count {
  display: inline-block;
  background: rgba(255,102,0,0.2);
  color: #FF6600;
  font-size: 9px;
  padding: 1px 5px;
  border-radius: 2px;
  margin-left: auto;
}

/* â”€â”€ Hover Tooltip â”€â”€ */
#tooltip {
  position: fixed;
  display: none;
  background: rgba(0,0,0,0.95);
  border: 1px solid #FF6600;
  border-left: 3px solid #FF6600;
  padding: 12px 14px;
  max-width: 280px;
  min-width: 200px;
  z-index: 200;
  pointer-events: none;
  backdrop-filter: blur(8px);
}
#tooltip .tt-category {
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 5px;
}
#tooltip .tt-title {
  color: #FFFFFF;
  font-size: 11px;
  line-height: 1.4;
  margin-bottom: 6px;
}
#tooltip .tt-meta {
  color: #555;
  font-size: 9px;
  letter-spacing: 1px;
  margin-top: 4px;
}
#tooltip .tt-source {
  color: #FF6600;
  font-size: 9px;
}
#tooltip .tt-link {
  color: #FF8C00;
  font-size: 9px;
  text-decoration: underline;
  display: block;
  margin-top: 4px;
  cursor: pointer;
}
#tooltip .tt-link:hover { color: #FFFFFF; }

/* â”€â”€ Event Feed â”€â”€ */
#event-feed {
  position: fixed;
  bottom: 0; right: 0;
  width: 300px;
  max-height: 240px;
  background: rgba(0,0,0,0.88);
  border-top: 1px solid #1A1A1A;
  border-left: 1px solid #1A1A1A;
  z-index: 50;
  overflow-y: auto;
  backdrop-filter: blur(8px);
}
#event-feed-header {
  padding: 7px 12px;
  border-bottom: 1px solid #1A1A1A;
  font-size: 9px;
  color: #FF6600;
  font-weight: 700;
  letter-spacing: 2px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.feed-item {
  padding: 6px 12px;
  border-bottom: 1px solid #0D0D0D;
  font-size: 9px;
  color: #666;
  cursor: pointer;
  transition: background 0.15s;
  line-height: 1.4;
}
.feed-item:hover { background: rgba(255,102,0,0.05); color: #FF8C00; }
.feed-item .feed-title { color: #CCCCCC; font-size: 10px; margin-bottom: 2px; }
.feed-item .feed-region { color: #FF6600; font-size: 8px; letter-spacing: 1px; }
.feed-item a { color: #CCCCCC; text-decoration: none; }
.feed-item a:hover { color: #FF8C00; text-decoration: underline; }

/* â”€â”€ Status bar â”€â”€ */
#statusbar {
  position: fixed;
  bottom: 0; left: 220px; right: 300px;
  height: 26px;
  background: rgba(0,0,0,0.9);
  border-top: 1px solid #1A1A1A;
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 20px;
  font-size: 9px;
  color: #444;
  letter-spacing: 1px;
  z-index: 50;
}
#statusbar span { color: #555; }
#statusbar .highlight { color: #FF6600; }

/* â”€â”€ Loading overlay â”€â”€ */
#loading {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}
.loading-logo { color: #FF6600; font-size: 28px; font-weight: 900; letter-spacing: 8px; }
.loading-sub  { color: #555; font-size: 10px; letter-spacing: 4px; }
.loading-bar {
  width: 200px; height: 2px;
  background: #1A1A1A;
  border-radius: 2px;
  overflow: hidden;
}
.loading-bar-fill {
  height: 100%;
  background: #FF6600;
  width: 0%;
  animation: load 2s ease-out forwards;
}
@keyframes load {
  0%   { width: 0%; }
  60%  { width: 70%; }
  100% { width: 100%; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: #000; }
::-webkit-scrollbar-thumb { background: #FF6600; }
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
  <div class="loading-logo">SENTINEL</div>
  <div class="loading-sub">LOADING GEOPOLITICAL INTELLIGENCE GLOBE</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
  <div id="loading-status" style="color:#333;font-size:9px;letter-spacing:2px">INITIALIZING CESIUMâ€¦</div>
</div>

<!-- Top Bar -->
<div id="topbar">
  <div class="logo">âš¡ SENTINEL GEO GLOBE</div>
  <div class="status">
    <span id="event-count-label" style="color:#888">LOADING EVENTSâ€¦</span>
    <span class="live"><div id="live-dot"></div> LIVE GDELT FEED</span>
    <span id="clock">00:00:00</span>
  </div>
</div>

<!-- Left Panel -->
<div id="left-panel">
  <div class="panel-section">
    <div class="panel-title">FILTER BY CATEGORY</div>
    <div class="filter-btn active" data-cat="all" onclick="filterCategory('all', this)">
      <div class="filter-dot" style="background:#FF6600"></div>
      <span>ALL EVENTS</span>
      <span class="event-count" id="cnt-all">0</span>
    </div>
    <div class="filter-btn" data-cat="conflict" onclick="filterCategory('conflict', this)">
      <div class="filter-dot" style="background:#FF0000"></div>
      <span>CONFLICT</span>
      <span class="event-count" id="cnt-conflict">0</span>
    </div>
    <div class="filter-btn" data-cat="energy" onclick="filterCategory('energy', this)">
      <div class="filter-dot" style="background:#FF8C00"></div>
      <span>ENERGY</span>
      <span class="event-count" id="cnt-energy">0</span>
    </div>
    <div class="filter-btn" data-cat="trade" onclick="filterCategory('trade', this)">
      <div class="filter-dot" style="background:#00AAFF"></div>
      <span>TRADE</span>
      <span class="event-count" id="cnt-trade">0</span>
    </div>
    <div class="filter-btn" data-cat="political" onclick="filterCategory('political', this)">
      <div class="filter-dot" style="background:#AA44FF"></div>
      <span>POLITICAL</span>
      <span class="event-count" id="cnt-political">0</span>
    </div>
    <div class="filter-btn" data-cat="economic" onclick="filterCategory('economic', this)">
      <div class="filter-dot" style="background:#00CC44"></div>
      <span>ECONOMIC</span>
      <span class="event-count" id="cnt-economic">0</span>
    </div>
    <div class="filter-btn" data-cat="natural" onclick="filterCategory('natural', this)">
      <div class="filter-dot" style="background:#FFFF00"></div>
      <span>NATURAL</span>
      <span class="event-count" id="cnt-natural">0</span>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-title">THEATERS</div>
    <div class="theater-item critical" onclick="flyTo(35, 36, 2500000)">ğŸ”´ Middle East</div>
    <div class="theater-item active"   onclick="flyTo(48, 31, 3000000)">ğŸ”´ Ukraine</div>
    <div class="theater-item active"   onclick="flyTo(20, 45, 3000000)">ğŸ”´ Red Sea</div>
    <div class="theater-item elevated" onclick="flyTo(14, 2, 3500000)">ğŸŸ  Sahel</div>
    <div class="theater-item elevated" onclick="flyTo(26, 56, 2800000)">ğŸŸ  Hormuz</div>
    <div class="theater-item monitor"  onclick="flyTo(23, 120, 2500000)">ğŸŸ¡ Taiwan Strait</div>
    <div class="theater-item monitor"  onclick="flyTo(15, 115, 3000000)">ğŸŸ¡ S. China Sea</div>
    <div class="theater-item monitor"  onclick="flyTo(35, 130, 4000000)">ğŸŸ¡ Korean Peninsula</div>
  </div>

  <div class="panel-section">
    <div class="panel-title">LEGEND</div>
    <div style="font-size:9px;color:#555;line-height:2">
      <div><span style="color:#FF0000">â—</span> Conflict / Military</div>
      <div><span style="color:#FF8C00">â—</span> Energy / Resources</div>
      <div><span style="color:#00AAFF">â—</span> Trade / Economic</div>
      <div><span style="color:#AA44FF">â—</span> Political / Diplomatic</div>
      <div><span style="color:#00CC44">â—</span> Economic Signal</div>
      <div><span style="color:#FFFF00">â—</span> Natural / Humanitarian</div>
      <br>
      <div style="color:#666">HOVER markers for detail</div>
      <div style="color:#666">CLICK to open source</div>
    </div>
  </div>

  <div class="panel-section">
    <div class="panel-title">CONTROLS</div>
    <div style="font-size:9px;color:#555;line-height:2">
      <div>ğŸ–± Drag â€” Rotate</div>
      <div>ğŸ–± Scroll â€” Zoom</div>
      <div>ğŸ–± Right drag â€” Tilt</div>
      <div>ğŸ–± Middle â€” Pan</div>
    </div>
    <div style="margin-top:8px">
      <button onclick="resetView()" style="width:100%;background:#0A0A0A;color:#FF6600;border:1px solid #FF6600;padding:5px;font-size:9px;cursor:pointer;font-family:Courier New;letter-spacing:1px">
        â†º RESET VIEW
      </button>
    </div>
    <div style="margin-top:4px">
      <button onclick="toggleNight()" id="night-btn" style="width:100%;background:#0A0A0A;color:#555;border:1px solid #333;padding:5px;font-size:9px;cursor:pointer;font-family:Courier New;letter-spacing:1px">
        â˜¾ TOGGLE NIGHT
      </button>
    </div>
  </div>
</div>

<!-- Tooltip -->
<div id="tooltip">
  <div class="tt-category" id="tt-cat">LOADINGâ€¦</div>
  <div class="tt-title" id="tt-title">Event title</div>
  <div class="tt-source" id="tt-source">Source</div>
  <div class="tt-meta" id="tt-meta">Region Â· Date</div>
  <a class="tt-link" id="tt-link" target="_blank" href="#">â†— Open source article</a>
</div>

<!-- Cesium Globe -->
<div id="cesiumContainer"></div>

<!-- Event Feed -->
<div id="event-feed">
  <div id="event-feed-header">
    <span>LIVE EVENT FEED</span>
    <span id="feed-count" style="color:#555;font-size:8px">0 events</span>
  </div>
  <div id="feed-items"></div>
</div>

<!-- Status Bar -->
<div id="statusbar">
  <span>DRAG TO ROTATE</span>
  <span>SCROLL TO ZOOM</span>
  <span>HOVER MARKERS FOR INTEL</span>
  <span class="highlight" id="last-update">UPDATINGâ€¦</span>
  <span>AUTO-REFRESH: 5 MIN</span>
</div>

<script>
// â”€â”€ CesiumJS Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Using default anonymous access (limited but functional for globe)
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWE1OWUxNy1mMWZiLTQzYjYtYTQ0OS1kMWFjYmFkNjc4ZTYiLCJpZCI6NTc3MzMsImlhdCI6MTYyNzg0NTE4Mn0.XcKpgANiY19MC4bdFUXMVEBToBmqS8kuYpUlxJHYZxk';

// â”€â”€ Global State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let viewer, allEvents = [], entities = [], currentFilter = 'all', nightMode = false;

// â”€â”€ Category Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORIES = {
  conflict:  { color: Cesium.Color.fromCssColorString('#FF2200').withAlpha(0.9), pulse: true,  size: 14 },
  energy:    { color: Cesium.Color.fromCssColorString('#FF8C00').withAlpha(0.85),pulse: false, size: 12 },
  trade:     { color: Cesium.Color.fromCssColorString('#00AAFF').withAlpha(0.85),pulse: false, size: 11 },
  political: { color: Cesium.Color.fromCssColorString('#BB44FF').withAlpha(0.85),pulse: false, size: 11 },
  economic:  { color: Cesium.Color.fromCssColorString('#00DD55').withAlpha(0.85),pulse: false, size: 11 },
  natural:   { color: Cesium.Color.fromCssColorString('#FFFF00').withAlpha(0.85),pulse: false, size: 10 },
};

// â”€â”€ GDELT Geo Query Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GEO_QUERIES = [
  { q: 'conflict military attack war',         cat: 'conflict',  regions: GEO_CONFLICT_LOCS  },
  { q: 'oil gas energy pipeline sanction',     cat: 'energy',    regions: GEO_ENERGY_LOCS    },
  { q: 'trade tariff sanction economy import', cat: 'trade',     regions: GEO_TRADE_LOCS     },
  { q: 'election coup government protest',     cat: 'political', regions: GEO_POLITICAL_LOCS },
  { q: 'GDP inflation rate central bank',      cat: 'economic',  regions: GEO_ECONOMIC_LOCS  },
  { q: 'earthquake flood disaster humanitarian',cat:'natural',   regions: GEO_NATURAL_LOCS   },
];

// â”€â”€ Geo-coordinate lookup tables (major news hotspots) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REGION_COORDS = {
  // Middle East
  'israel': [31.5, 34.9], 'iran': [32.0, 53.0], 'iraq': [33.0, 44.0],
  'syria': [35.0, 38.5], 'lebanon': [33.9, 35.5], 'yemen': [15.5, 47.5],
  'saudi': [24.0, 45.0], 'uae': [24.0, 54.0], 'qatar': [25.3, 51.2],
  'jordan': [31.0, 36.0], 'egypt': [26.0, 30.0], 'turkey': [38.9, 35.2],
  // Europe
  'ukraine': [49.0, 31.0], 'russia': [61.5, 90.0], 'poland': [52.0, 19.0],
  'germany': [51.2, 10.5], 'france': [46.2, 2.2], 'uk': [54.0, -2.0],
  'nato': [50.9, 4.3],
  // Asia Pacific
  'china': [35.0, 103.0], 'taiwan': [23.7, 121.0], 'japan': [36.2, 138.3],
  'korea': [37.6, 127.0], 'india': [20.6, 79.0], 'pakistan': [30.4, 69.3],
  'myanmar': [17.1, 96.2], 'thailand': [15.9, 100.9],
  // Africa
  'nigeria': [9.1, 8.7], 'ethiopia': [9.1, 40.5], 'somalia': [5.2, 46.2],
  'sudan': [12.9, 30.2], 'mali': [17.6, -4.0], 'niger': [13.5, 2.1],
  'drc': [-4.0, 21.8], 'mozambique': [-18.7, 35.5], 'ghana': [7.9, -1.0],
  // Americas
  'venezuela': [6.4, -66.6], 'colombia': [4.6, -74.1], 'brazil': [-14.2, -51.9],
  'mexico': [23.6, -102.6], 'haiti': [18.9, -72.3],
  // Shipping
  'red sea': [20.0, 44.0], 'hormuz': [26.6, 56.3], 'suez': [30.5, 32.3],
  'panama': [8.5, -79.5], 'south china sea': [15.0, 115.0],
  'taiwan strait': [24.0, 119.0], 'bosphorus': [41.1, 29.0],
};

function coordsForArticle(title, url, domain) {
  const text = (title + ' ' + domain).toLowerCase();
  for (const [keyword, coords] of Object.entries(REGION_COORDS)) {
    if (text.includes(keyword)) {
      // Add slight jitter to avoid exact stacking
      return [
        coords[0] + (Math.random() - 0.5) * 2,
        coords[1] + (Math.random() - 0.5) * 2
      ];
    }
  }
  return null;
}

// â”€â”€ GDELT Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchGDELT(query, maxRecords = 12) {
  const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${encodeURIComponent(query)}&mode=artlist&maxrecords=${maxRecords}&format=json&timespan=24h`;
  try {
    const r = await fetch(url);
    const d = await r.json();
    return d.articles || [];
  } catch(e) {
    return [];
  }
}

async function loadAllEvents() {
  const loadStatus = document.getElementById('loading-status');
  if (loadStatus) loadStatus.textContent = 'FETCHING GDELT INTELLIGENCEâ€¦';

  const queries = [
    { q: 'military conflict war attack', cat: 'conflict' },
    { q: 'Iran Israel Gaza West Bank', cat: 'conflict' },
    { q: 'Ukraine Russia NATO military', cat: 'conflict' },
    { q: 'oil gas energy pipeline', cat: 'energy' },
    { q: 'OPEC Saudi Arabia oil price', cat: 'energy' },
    { q: 'trade tariff sanction WTO', cat: 'trade' },
    { q: 'China Taiwan semiconductor export', cat: 'trade' },
    { q: 'election government coup protest', cat: 'political' },
    { q: 'central bank interest rate inflation', cat: 'economic' },
    { q: 'earthquake flood disaster', cat: 'natural' },
    { q: 'Red Sea Houthi shipping', cat: 'conflict' },
    { q: 'Africa Sahel coup mining', cat: 'political' },
  ];

  const rawEvents = [];
  for (const q of queries) {
    const arts = await fetchGDELT(q.q, 8);
    for (const art of arts) {
      const title  = art.title || '';
      const url_   = art.url || '#';
      const domain = art.domain || '';
      const sd     = art.seendate || '';
      const date   = sd.length >= 8 ? `${sd.slice(0,4)}-${sd.slice(4,6)}-${sd.slice(6,8)}` : '';
      const coords = coordsForArticle(title, url_, domain);
      if (coords) {
        rawEvents.push({
          title, url: url_, domain, date, cat: q.cat,
          lat: coords[0], lon: coords[1]
        });
      }
    }
  }

  // Deduplicate by URL
  const seen = new Set();
  allEvents = rawEvents.filter(e => {
    if (seen.has(e.url)) return false;
    seen.add(e.url);
    return true;
  });

  if (loadStatus) loadStatus.textContent = `MAPPED ${allEvents.length} EVENTS`;
  return allEvents;
}

// â”€â”€ Cesium Globe Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initGlobe() {
  try {
    // Create viewer with realistic imagery
    viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: await Cesium.createWorldTerrainAsync(),
      animation:         false,
      timeline:          false,
      baseLayerPicker:   false,
      navigationHelpButton: true,
      homeButton:        false,
      sceneModePicker:   false,
      geocoder:          false,
      infoBox:           false,
      selectionIndicator: false,
      fullscreenButton:  false,
      creditContainer:   document.createElement('div'), // hide credits
    });

    // Atmosphere and lighting for realism
    viewer.scene.globe.enableLighting = true;
    viewer.scene.atmosphere.show = true;
    viewer.scene.skyAtmosphere.show = true;
    viewer.scene.globe.showGroundAtmosphere = true;
    viewer.scene.fog.enabled = true;
    viewer.scene.fog.density = 0.00025;

    // Set night lighting to see city lights
    viewer.scene.globe.nightFadeOutDistance = 1e7;
    viewer.scene.globe.nightFadeInDistance  = 5e6;

    // Deep space background
    viewer.scene.backgroundColor = Cesium.Color.fromCssColorString('#000005');

    // Initial camera position - angled view
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(20, 20, 18000000),
      orientation: {
        heading: Cesium.Math.toRadians(0),
        pitch:   Cesium.Math.toRadians(-35),
        roll:    0
      }
    });

    // Load events
    const loadStatus = document.getElementById('loading-status');
    if (loadStatus) loadStatus.textContent = 'FETCHING GLOBAL INTELLIGENCEâ€¦';

    await loadAllEvents();
    renderMarkers();
    updateCounts();
    populateFeed();

    // Hide loading screen
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
    }, 600);

    // Set up hover detection
    setupHover();

    // Auto-refresh every 5 minutes
    setInterval(async () => {
      await loadAllEvents();
      clearMarkers();
      renderMarkers(currentFilter);
      updateCounts();
      populateFeed();
      document.getElementById('last-update').textContent =
        'UPDATED ' + new Date().toLocaleTimeString('en-US', {hour12:false});
    }, 300000);

    document.getElementById('last-update').textContent =
      'UPDATED ' + new Date().toLocaleTimeString('en-US', {hour12:false});
    document.getElementById('event-count-label').textContent =
      `${allEvents.length} EVENTS MAPPED`;

  } catch(e) {
    console.error('Cesium init error:', e);
    // Fallback to basic globe
    initFallbackGlobe();
  }
}

function renderMarkers(filter) {
  const toRender = filter && filter !== 'all'
    ? allEvents.filter(e => e.cat === filter)
    : allEvents;

  for (const ev of toRender) {
    const cfg  = CATEGORIES[ev.cat] || CATEGORIES.economic;
    const size = cfg.size;

    const entity = viewer.entities.add({
      position: Cesium.Cartesian3.fromDegrees(ev.lon, ev.lat, 0),
      billboard: {
        image:  createMarkerCanvas(cfg.color.toCssColorString(), size),
        width:  size * 2,
        height: size * 2,
        verticalOrigin:   Cesium.VerticalOrigin.CENTER,
        horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
        disableDepthTestDistance: Number.POSITIVE_INFINITY,
        heightReference: Cesium.HeightReference.NONE,
      },
      label: undefined,
      properties: {
        title:    ev.title,
        url:      ev.url,
        domain:   ev.domain,
        date:     ev.date,
        cat:      ev.cat,
      }
    });

    // Pulse ring for conflict events
    if (ev.cat === 'conflict') {
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(ev.lon, ev.lat, 0),
        ellipse: {
          semiMajorAxis: 150000,
          semiMinorAxis: 150000,
          material: new Cesium.ColorMaterialProperty(
            Cesium.Color.fromCssColorString('#FF2200').withAlpha(0.15)
          ),
          outline: true,
          outlineColor: Cesium.Color.fromCssColorString('#FF2200').withAlpha(0.4),
          outlineWidth: 1,
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
        }
      });
    }

    entities.push(entity);
  }
}

function createMarkerCanvas(color, size) {
  const canvas = document.createElement('canvas');
  const s = size * 2;
  canvas.width = s; canvas.height = s;
  const ctx = canvas.getContext('2d');

  // Glow
  const glow = ctx.createRadialGradient(s/2,s/2,0, s/2,s/2,s/2);
  glow.addColorStop(0, color.replace(')', ',0.8)').replace('rgb','rgba'));
  glow.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = glow;
  ctx.fillRect(0, 0, s, s);

  // Core dot
  ctx.beginPath();
  ctx.arc(s/2, s/2, size*0.4, 0, Math.PI*2);
  ctx.fillStyle = color;
  ctx.fill();

  // Ring
  ctx.beginPath();
  ctx.arc(s/2, s/2, size*0.65, 0, Math.PI*2);
  ctx.strokeStyle = color.replace(')', ',0.5)').replace('rgb','rgba');
  ctx.lineWidth = 1;
  ctx.stroke();

  return canvas.toDataURL();
}

function clearMarkers() {
  entities.forEach(e => viewer.entities.remove(e));
  entities = [];
}

function setupHover() {
  const tooltip = document.getElementById('tooltip');
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

  handler.setInputAction((movement) => {
    const picked = viewer.scene.pick(movement.endPosition);
    if (Cesium.defined(picked) && Cesium.defined(picked.id) && picked.id.properties) {
      const props = picked.id.properties;
      const title  = props.title ? props.title.getValue() : '';
      const url    = props.url   ? props.url.getValue()   : '#';
      const domain = props.domain ? props.domain.getValue() : '';
      const date   = props.date  ? props.date.getValue()  : '';
      const cat    = props.cat   ? props.cat.getValue()   : '';

      const catColors = {
        conflict: '#FF0000', energy: '#FF8C00', trade: '#00AAFF',
        political: '#BB44FF', economic: '#00DD55', natural: '#FFFF00'
      };
      const catLabel = cat.toUpperCase();
      const color    = catColors[cat] || '#FF6600';

      document.getElementById('tt-cat').textContent  = catLabel;
      document.getElementById('tt-cat').style.color  = color;
      document.getElementById('tt-title').textContent = title.length > 80
        ? title.slice(0, 80) + 'â€¦' : title;
      document.getElementById('tt-source').textContent = domain;
      document.getElementById('tt-meta').textContent   = date;

      const link = document.getElementById('tt-link');
      link.href = url;
      link.textContent = url !== '#' ? 'â†— Open source article' : '(no link)';

      // Position tooltip
      const x = movement.endPosition.x;
      const y = movement.endPosition.y;
      const w = tooltip.offsetWidth || 280;
      const h = tooltip.offsetHeight || 120;
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      tooltip.style.left   = (x + 220 + w > vw ? x - w - 10 : x + 220 + 16) + 'px';
      tooltip.style.top    = (y + h > vh ? y - h - 10 : y - 10) + 'px';
      tooltip.style.display = 'block';
      tooltip.style.borderLeftColor = color;
      document.body.style.cursor = 'pointer';
    } else {
      tooltip.style.display = 'none';
      document.body.style.cursor = 'default';
    }
  }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

  // Click to open link
  handler.setInputAction((click) => {
    const picked = viewer.scene.pick(click.position);
    if (Cesium.defined(picked) && Cesium.defined(picked.id) && picked.id.properties) {
      const url = picked.id.properties.url ? picked.id.properties.url.getValue() : '#';
      if (url && url !== '#') window.open(url, '_blank');
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

function filterCategory(cat, btn) {
  currentFilter = cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  clearMarkers();
  renderMarkers(cat === 'all' ? null : cat);
}

function flyTo(lat, lon, height) {
  if (!viewer) return;
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(lon, lat, height || 3000000),
    duration: 2.0,
    orientation: {
      heading: Cesium.Math.toRadians(0),
      pitch: Cesium.Math.toRadians(-25),
      roll: 0
    }
  });
}

function resetView() {
  if (!viewer) return;
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(20, 20, 18000000),
    duration: 2.0,
    orientation: {
      heading: 0, pitch: Cesium.Math.toRadians(-35), roll: 0
    }
  });
}

function toggleNight() {
  if (!viewer) return;
  nightMode = !nightMode;
  viewer.scene.globe.enableLighting = nightMode;
  const btn = document.getElementById('night-btn');
  if (nightMode) {
    btn.style.color = '#FF8C00';
    btn.style.borderColor = '#FF6600';
    btn.textContent = 'â˜€ DAY MODE';
    // Set to nighttime
    viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date('2024-01-01T00:00:00Z'));
    viewer.clock.shouldAnimate = false;
  } else {
    btn.style.color = '#555';
    btn.style.borderColor = '#333';
    btn.textContent = 'â˜¾ TOGGLE NIGHT';
    viewer.clock.currentTime = Cesium.JulianDate.now();
  }
}

function updateCounts() {
  const cats = ['conflict','energy','trade','political','economic','natural'];
  document.getElementById('cnt-all').textContent = allEvents.length;
  for (const cat of cats) {
    const cnt = allEvents.filter(e => e.cat === cat).length;
    const el  = document.getElementById(`cnt-${cat}`);
    if (el) el.textContent = cnt;
  }
  document.getElementById('event-count-label').textContent = `${allEvents.length} EVENTS MAPPED`;
  document.getElementById('feed-count').textContent = `${allEvents.length} events`;
}

function populateFeed() {
  const container = document.getElementById('feed-items');
  container.innerHTML = '';
  const catColors = {
    conflict: '#FF0000', energy: '#FF8C00', trade: '#00AAFF',
    political: '#BB44FF', economic: '#00DD55', natural: '#FFFF00'
  };
  const recent = [...allEvents].slice(0, 20);
  for (const ev of recent) {
    const color = catColors[ev.cat] || '#FF6600';
    const div   = document.createElement('div');
    div.className = 'feed-item';
    div.innerHTML = `
      <div class="feed-title">
        ${ev.url !== '#'
          ? `<a href="${ev.url}" target="_blank">${ev.title.slice(0,60)}${ev.title.length>60?'â€¦':''}</a>`
          : ev.title.slice(0,60) + (ev.title.length>60?'â€¦':'')}
      </div>
      <div class="feed-region">
        <span style="color:${color}">${ev.cat.toUpperCase()}</span>
        &nbsp;|&nbsp; ${ev.domain} &nbsp;|&nbsp; ${ev.date}
      </div>`;

    div.addEventListener('click', () => {
      if (viewer) {
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(ev.lon, ev.lat, 3000000),
          duration: 1.5,
        });
      }
    });
    container.appendChild(div);
  }
}

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const h   = String(now.getUTCHours()).padStart(2,'0');
  const m   = String(now.getUTCMinutes()).padStart(2,'0');
  const s   = String(now.getUTCSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s} UTC`;
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ Fallback Globe (Three.js) if Cesium fails â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFallbackGlobe() {
  document.getElementById('loading').style.display = 'none';
  const container = document.getElementById('cesiumContainer');
  container.innerHTML = `
<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#000;color:#FF6600;font-family:Courier New;font-size:14px;text-align:center">
  <div>
    <div style="font-size:24px;margin-bottom:16px">ğŸŒ</div>
    <div>GDELT EVENTS LOADED</div>
    <div style="color:#555;font-size:11px;margin-top:8px">Cesium globe requires network access.<br>Use the event feed on the right â†’</div>
  </div>
</div>`;
  // Still populate event feed
  populateFeed();
  updateCounts();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', initGlobe);
</script>
</body>
</html>

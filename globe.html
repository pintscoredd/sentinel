<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SENTINEL GLOBE</title>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Courier New',monospace;}
body{background:#070809;color:#d0d3d8;overflow:hidden;}
#cesiumContainer{width:100vw;height:100vh;position:relative;}
#scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.02) 2px,rgba(0,0,0,0.02) 4px);pointer-events:none;z-index:10;}
#vignette{position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 55%,rgba(0,0,0,0.65) 100%);pointer-events:none;z-index:9;}
#header{position:fixed;top:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,rgba(7,8,9,0.97) 0%,transparent 100%);padding:8px 16px;display:flex;justify-content:space-between;align-items:center;}
#logo{color:#f5a623;font-size:14px;font-weight:700;letter-spacing:4px;}
#hstatus{font-size:9px;color:#444851;display:flex;gap:12px;align-items:center;}
.hdot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;}
.hdot-g{background:#00e676;box-shadow:0 0 5px #00e676;animation:pb 2s infinite;}
.hdot-a{background:#f5a623;box-shadow:0 0 5px #f5a623;}
.hdot-r{background:#ff3b3b;box-shadow:0 0 5px #ff3b3b;animation:pb 1s infinite;}
@keyframes pb{0%,100%{opacity:1}50%{opacity:0.3}}
#filterbar{position:fixed;left:12px;top:52px;z-index:20;display:flex;flex-direction:column;gap:3px;}
.fbtn{background:rgba(7,8,9,0.92);border:1px solid #1e2025;color:#8a8f99;font-family:'Courier New',monospace;font-size:9px;letter-spacing:1px;padding:5px 10px;cursor:pointer;transition:all 0.15s;text-align:left;width:110px;}
.fbtn:hover,.fbtn.active{background:rgba(245,166,35,0.08);border-color:#f5a623;color:#f5a623;}
#threatpanel{position:fixed;right:0;top:52px;width:200px;background:rgba(7,8,9,0.95);border:1px solid #1e2025;border-right:none;z-index:20;}
.tph{padding:5px 10px;font-size:9px;letter-spacing:2px;color:#f5a623;border-bottom:1px solid #1e2025;background:rgba(245,166,35,0.04);}
.tpi{padding:7px 10px;border-bottom:1px solid #111316;cursor:pointer;transition:background 0.15s;}
.tpi:hover{background:rgba(245,166,35,0.06);}
.tpn{font-size:10px;color:#d0d3d8;font-weight:600;}
.tps{font-size:9px;margin-top:2px;}
.tc{color:#ff3b3b;} .te{color:#f5a623;} .tw{color:#4fc3f7;}
#infocard{position:fixed;background:rgba(7,8,9,0.97);border:1px solid #1e2025;border-left:3px solid #f5a623;padding:14px 16px;width:310px;z-index:30;display:none;pointer-events:none;backdrop-filter:blur(8px);}
#infocard.show{display:block;}
#infocard.critical{border-left-color:#ff3b3b;}
#infocard.elevated{border-left-color:#f5a623;}
#infocard.watch{border-left-color:#4fc3f7;}
.ic-lbl{font-size:8px;letter-spacing:2px;color:#444851;margin-bottom:3px;}
.ic-ttl{font-size:12px;font-weight:600;color:#f0f2f5;margin-bottom:6px;}
.ic-body{font-size:10px;color:#8a8f99;line-height:1.6;}
.ic-mkt{color:#4fc3f7;margin-top:6px;font-size:10px;}
.ic-tags{margin-top:8px;display:flex;gap:5px;flex-wrap:wrap;}
.ic-tag{font-size:8px;padding:2px 6px;border:1px solid #1e2025;color:#444851;}
#addbtn{position:fixed;right:210px;bottom:60px;z-index:20;background:rgba(245,166,35,0.1);border:1px solid #f5a623;color:#f5a623;font-family:'Courier New',monospace;font-size:10px;padding:6px 12px;cursor:pointer;letter-spacing:1px;}
#addbtn:hover{background:rgba(245,166,35,0.2);}
#adddlg{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0d0e10;border:1px solid #f5a623;padding:20px;width:360px;z-index:50;display:none;}
#adddlg.show{display:block;}
#adddlg h3{color:#f5a623;font-size:11px;letter-spacing:2px;margin-bottom:14px;}
#adddlg label{font-size:9px;color:#8a8f99;display:block;margin-bottom:3px;letter-spacing:1px;}
#adddlg input,#adddlg select,#adddlg textarea{width:100%;background:#070809;border:1px solid #1e2025;color:#d0d3d8;font-family:'Courier New',monospace;font-size:10px;padding:5px 8px;margin-bottom:10px;}
#adddlg textarea{height:60px;resize:none;}
.dlg-btns{display:flex;gap:8px;margin-top:4px;}
.dlg-btn{flex:1;padding:6px;font-family:'Courier New',monospace;font-size:10px;cursor:pointer;border:1px solid #f5a623;}
.dlg-ok{background:rgba(245,166,35,0.15);color:#f5a623;}
.dlg-ok:hover{background:rgba(245,166,35,0.3);}
.dlg-cancel{background:transparent;color:#8a8f99;border-color:#1e2025;}
#statusbar{position:fixed;bottom:0;left:0;right:0;padding:5px 16px;display:flex;justify-content:space-between;background:linear-gradient(0deg,rgba(7,8,9,0.98) 0%,transparent 100%);z-index:20;font-size:8px;letter-spacing:1px;color:#444851;}
#ticker{position:fixed;bottom:22px;left:0;right:0;overflow:hidden;height:18px;background:rgba(7,8,9,0.7);z-index:20;}
#ticker-i{display:inline-block;animation:stl 65s linear infinite;white-space:nowrap;font-size:9px;color:#444851;padding:2px 0;}
@keyframes stl{0%{transform:translateX(100vw)}100%{transform:translateX(-100%)}}
#addedlist{position:fixed;left:12px;bottom:50px;z-index:20;max-width:200px;display:flex;flex-direction:column;gap:3px;}
.added-event{background:rgba(7,8,9,0.92);border:1px solid #1e2025;border-left:2px solid #f5a623;padding:4px 8px;font-size:9px;color:#8a8f99;cursor:pointer;}
.added-event:hover{border-left-color:#00e676;color:#d0d3d8;}
</style>
</head>
<body>
<div id="scanlines"></div>
<div id="vignette"></div>

<div id="header">
  <div>
    <span id="logo">‚ö° SENTINEL GEO</span>
    <span style="color:#444851;font-size:9px;margin-left:12px">GEOPOLITICAL INTELLIGENCE LAYER</span>
  </div>
  <div id="hstatus">
    <span><span class="hdot hdot-g"></span>CESIUM SATELLITE</span>
    <span><span class="hdot hdot-g"></span>GDELT LIVE</span>
    <span><span class="hdot hdot-a"></span>AIS FEED</span>
    <span id="clocktxt"></span>
  </div>
</div>

<div id="filterbar">
  <div class="fbtn active" data-f="all">‚óâ ALL EVENTS</div>
  <div class="fbtn" data-f="conflict">‚óà CONFLICT</div>
  <div class="fbtn" data-f="energy">‚óà ENERGY</div>
  <div class="fbtn" data-f="shipping">‚óà SHIPPING</div>
  <div class="fbtn" data-f="minerals">‚óà MINERALS</div>
  <div class="fbtn" data-f="trade">‚óà TRADE / TECH</div>
  <div class="fbtn" data-f="custom">‚óà MY EVENTS</div>
</div>

<div id="threatpanel">
  <div class="tph">‚ñ∂ THEATERS</div>
  <div class="tpi" data-lat="31.5" data-lon="34.8"><div class="tpn">MIDDLE EAST</div><div class="tps tc">‚óè CRITICAL</div></div>
  <div class="tpi" data-lat="25" data-lon="121"><div class="tpn">TAIWAN STRAIT</div><div class="tps te">‚óâ ELEVATED</div></div>
  <div class="tpi" data-lat="49" data-lon="31"><div class="tpn">UKRAINE FRONT</div><div class="tps tc">‚óè ACTIVE</div></div>
  <div class="tpi" data-lat="14" data-lon="2"><div class="tpn">SAHEL / AFRICA</div><div class="tps te">‚óâ ELEVATED</div></div>
  <div class="tpi" data-lat="14" data-lon="43"><div class="tpn">RED SEA / SUEZ</div><div class="tps tc">‚óè DISRUPTED</div></div>
  <div class="tpi" data-lat="12" data-lon="115"><div class="tpn">S CHINA SEA</div><div class="tps te">‚óâ ELEVATED</div></div>
  <div class="tpi" data-lat="26.5" data-lon="56"><div class="tpn">STRAIT HORMUZ</div><div class="tps te">‚óâ ELEVATED</div></div>
  <div class="tpi" data-lat="-5" data-lon="23.5"><div class="tpn">DRC / COBALT</div><div class="tps te">‚óâ WATCH</div></div>
</div>

<div id="infocard">
  <div class="ic-lbl" id="ic-lbl">EVENT</div>
  <div class="ic-ttl" id="ic-ttl">‚Äî</div>
  <div class="ic-body" id="ic-body">‚Äî</div>
  <div class="ic-mkt" id="ic-mkt"></div>
  <div class="ic-tags" id="ic-tags"></div>
</div>

<button id="addbtn" onclick="showAdd()">+ ADD EVENT</button>
<div id="addedlist"></div>

<div id="adddlg">
  <h3>+ ADD CUSTOM EVENT</h3>
  <label>EVENT TITLE</label>
  <input type="text" id="ev-title" placeholder="e.g. Tariff announcement affects steel">
  <label>LATITUDE (-90 to 90)</label>
  <input type="number" id="ev-lat" placeholder="e.g. 40.7" min="-90" max="90">
  <label>LONGITUDE (-180 to 180)</label>
  <input type="number" id="ev-lon" placeholder="e.g. -74.0" min="-180" max="180">
  <label>DESCRIPTION</label>
  <textarea id="ev-desc" placeholder="What happened? What's the market impact?"></textarea>
  <label>SEVERITY</label>
  <select id="ev-sev">
    <option value="critical">CRITICAL</option>
    <option value="elevated">ELEVATED</option>
    <option value="watch" selected>WATCH</option>
  </select>
  <label>MARKET IMPACT</label>
  <input type="text" id="ev-mkt" placeholder="e.g. XLE, Gold, DXY">
  <div class="dlg-btns">
    <button class="dlg-btn dlg-ok" onclick="addEvent()">ADD TO GLOBE</button>
    <button class="dlg-btn dlg-cancel" onclick="closeAdd()">CANCEL</button>
  </div>
</div>

<div id="ticker">
  <div id="ticker-i">
    <span style="color:#ff3b3b">‚óè</span> RED SEA: Houthi attacks ongoing ‚Äî shipping rerouting Cape of Good Hope ‚Äî voyage time +12 days &nbsp;&nbsp;///&nbsp;&nbsp;
    <span style="color:#f5a623">‚óâ</span> TAIWAN: PLA naval exercises 80nm east ‚Äî TSMC operations normal ‚Äî US carrier group present &nbsp;&nbsp;///&nbsp;&nbsp;
    <span style="color:#ff3b3b">‚óè</span> UKRAINE: Frontline active ‚Äî EU energy independence package announced &nbsp;&nbsp;///&nbsp;&nbsp;
    <span style="color:#f5a623">‚óâ</span> HORMUZ: IRGC elevated naval presence ‚Äî Lloyd's war risk premium elevated &nbsp;&nbsp;///&nbsp;&nbsp;
    <span style="color:#f5a623">‚óâ</span> SAHEL: Mali extends China mining rights ‚Äî cobalt supply chain watch &nbsp;&nbsp;///&nbsp;&nbsp;
    SENTINEL GEO | CESIUM SATELLITE IMAGERY | GDELT LIVE | CONFIDENCE: MEDIUM | VERIFY WITH PRIMARY SOURCES
  </div>
</div>

<div id="statusbar">
  <div><span class="hdot hdot-g" style="margin-right:4px"></span>SENTINEL ONLINE &nbsp;&nbsp; <span class="hdot hdot-r" style="margin-right:4px"></span>3 CRITICAL &nbsp;&nbsp; <span class="hdot hdot-a" style="margin-right:4px"></span>4 ELEVATED</div>
  <div>DRAG TO ROTATE ¬∑ SCROLL TO ZOOM ¬∑ CLICK MARKERS FOR INTEL ¬∑ HOVER FOR PREVIEW</div>
  <div>SOURCES: CESIUM ION ¬∑ ESRI SATELLITE ¬∑ GDELT ¬∑ AIS ¬∑ OPENSKY</div>
</div>

<div id="cesiumContainer"></div>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
<script>
// ‚îÄ‚îÄ CESIUM GLOBE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWE1OWUxNy1mMWZiLTQzYjYtYTQ0OS1kMWFjYmFkNjc5YzciLCJpZCIiMTU5NzMsImlhdCI6MTY5OTMwMTk3Mn0.tbLMnBGEguPYNpxVNJJqAbGjcGIJJtGPMIUJNa_gfls';

const viewer = new Cesium.Viewer('cesiumContainer', {
  imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
    url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
  }),
  baseLayerPicker: false,
  geocoder: false,
  homeButton: false,
  sceneModePicker: false,
  navigationHelpButton: false,
  animation: false,
  timeline: false,
  fullscreenButton: false,
  infoBox: false,
  selectionIndicator: false,
  shadows: false,
  terrainProvider: new Cesium.EllipsoidTerrainProvider()
});

// Dark atmosphere
viewer.scene.backgroundColor = Cesium.Color.fromCssColorString('#070809');
viewer.scene.globe.enableLighting = true;
viewer.scene.skyBox.show = false;
viewer.scene.sun.show = false;
viewer.scene.moon.show = false;
viewer.scene.globe.atmosphereBrightnessShift = -0.5;
viewer.scene.globe.atmosphereHueShift = 0.2;
viewer.scene.globe.atmosphereSaturationShift = -0.3;

// Set initial camera
viewer.camera.setView({
  destination: Cesium.Cartesian3.fromDegrees(20, 20, 18000000),
  orientation: { heading: 0, pitch: Cesium.Math.toRadians(-90), roll: 0 }
});

// ‚îÄ‚îÄ HOTSPOT DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOTSPOTS = [
  {lat:31.5,lon:34.8,label:'GAZA/ISRAEL',sev:'critical',type:'conflict',
   title:'Gaza ‚Äî Active Conflict Zone',
   body:'Ongoing operations. Civilian infrastructure severely degraded. Iran-backed proxy involvement. Regional escalation risk involves Hezbollah and IRGC.',
   mkt:'WTI Crude (CL=F), XLE, ITA (Defense ETF)',tags:['OIL RISK','ESCALATION','HUMANITARIAN']},
  {lat:14,lon:43,label:'RED SEA',sev:'critical',type:'shipping',
   title:'Red Sea ‚Äî Houthi Shipping Attacks',
   body:'Houthi attacks on commercial vessels ongoing. Ships rerouting around Cape of Good Hope (+12-14 day voyage). European import inflation rising as a result.',
   mkt:'Container rates, XLE, Airline stocks, European CPI',tags:['SHIPPING','INFLATION','TANKERS']},
  {lat:26.5,lon:56,label:'HORMUZ',sev:'elevated',type:'energy',
   title:'Strait of Hormuz ‚Äî Iranian Naval Presence',
   body:'IRGC maintaining elevated naval presence. 20% of global oil transits here. Any closure triggers immediate WTI/Brent spike. Lloyd\'s war risk premium elevated.',
   mkt:'WTI (CL=F), Brent, XLE, Airline margins',tags:['20% GLOBAL OIL','IRAN','TANKERS']},
  {lat:25,lon:121,label:'TAIWAN',sev:'elevated',type:'trade',
   title:'Taiwan Strait ‚Äî PLA Military Posture',
   body:'PLA conducting regular naval/air exercises. TSMC produces 90% of world\'s advanced chips. Any blockade = global semiconductor shock. US carrier groups present.',
   mkt:'SMH, NVDA, AAPL supply chain, SOXX',tags:['TSMC','SEMICONDUCTORS','CONFLICT RISK']},
  {lat:49,lon:31,label:'UKRAINE',sev:'critical',type:'conflict',
   title:'Ukraine ‚Äî Active War Theater',
   body:'Frontline active. Russia targeting energy infrastructure. European energy dependency declining. Ukrainian grain corridor periodically threatened. NATO posture elevated.',
   mkt:'Natural gas (NG=F), Wheat (ZW=F), European banks, ITA',tags:['NATGAS','GRAIN','NATO']},
  {lat:14,lon:2,label:'SAHEL',sev:'elevated',type:'minerals',
   title:'Sahel ‚Äî Coups & Critical Minerals',
   body:'Multiple coup governments across Mali, Niger, Burkina Faso. Chinese mining rights expanding. Mali is top-5 African gold producer. New lithium exploration deals being signed.',
   mkt:'GDX (gold miners), SIL, LIT (lithium ETF)',tags:['GOLD','LITHIUM','CHINA INFLUENCE']},
  {lat:-5,lon:23.5,label:'DRC/COBALT',sev:'elevated',type:'minerals',
   title:'DRC ‚Äî Cobalt Supply Chain',
   body:'DRC produces ~70% of world\'s cobalt ‚Äî critical for EV batteries. Eastern DRC conflict threatening mining. China controls most refining. ESG supply chain pressure.',
   mkt:'Cobalt, TSLA supply chain, ALB, SQM, LIT',tags:['70% COBALT','EV BATTERIES','CHINA']},
  {lat:12,lon:115,label:'S CHINA SEA',sev:'elevated',type:'shipping',
   title:'South China Sea ‚Äî Territorial Disputes',
   body:'$3T+ annual trade transits here. Philippines-China confrontations at Second Thomas Shoal. PLA asserting control over international waters. US naval presence active.',
   mkt:'Container shipping, semiconductors, Asian FX',tags:['$3T TRADE','NAVAL','TERRITORIAL']},
  {lat:56,lon:37.6,label:'RUSSIA',sev:'elevated',type:'energy',
   title:'Russia ‚Äî Energy Export Rerouting',
   body:'Russian oil/gas rerouted to China and India. European LNG costs remain elevated. Arctic LNG projects face equipment sanctions. Urals crude discount narrowing.',
   mkt:'European natgas, LNG stocks, UNG, XLE',tags:['LNG','SANCTIONS','RUSSIA-CHINA']},
  {lat:35.6,lon:139.7,label:'BOJ/YEN',sev:'watch',type:'trade',
   title:'Japan ‚Äî BOJ Policy & Yen Carry Trade',
   body:'BOJ normalizing ultra-loose policy. Yen carry trade unwind risk ‚Äî trillions in positions. JPY strength = global volatility event. Watch USD/JPY 145-150 range closely.',
   mkt:'USD/JPY, Nikkei, DXY, global bond markets',tags:['YEN CARRY','BOJ','VOLATILITY']},
  {lat:-20,lon:28,label:'ZIMBABWE',sev:'watch',type:'minerals',
   title:'Zimbabwe ‚Äî Lithium Export Controls',
   body:'Zimbabwe imposed raw lithium ore export ban. Chinese firms dominate local processing. Key EV battery supply chain node. Growing strategic importance for critical minerals.',
   mkt:'LIT (lithium ETF), ALB (Albemarle), SQM',tags:['LITHIUM','EV','EXPORT BAN']},
];

const COLORS = {critical:'#ff3b3b', elevated:'#f5a623', watch:'#4fc3f7'};
let customEvents = [];
let activeFilter = 'all';
let mouseX = 0, mouseY = 0;
let hoveredEntity = null;

// ‚îÄ‚îÄ ADD MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addMarker(hs, isCustom=false) {
  const color = Cesium.Color.fromCssColorString(COLORS[hs.sev] || '#4fc3f7');
  const pos = Cesium.Cartesian3.fromDegrees(hs.lon, hs.lat);

  const entity = viewer.entities.add({
    position: pos,
    point: {
      pixelSize: hs.sev==='critical' ? 10 : (hs.sev==='elevated' ? 8 : 7),
      color: color,
      outlineColor: color.withAlpha(0.3),
      outlineWidth: 8,
      heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
      disableDepthTestDistance: Number.POSITIVE_INFINITY,
      scaleByDistance: new Cesium.NearFarScalar(1e6, 1.2, 2e7, 0.5)
    },
    label: {
      text: hs.label,
      font: '9px Courier New',
      fillColor: Cesium.Color.fromCssColorString(COLORS[hs.sev] || '#4fc3f7'),
      outlineColor: Cesium.Color.fromCssColorString('#070809'),
      outlineWidth: 3,
      style: Cesium.LabelStyle.FILL_AND_OUTLINE,
      pixelOffset: new Cesium.Cartesian2(0, -18),
      heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
      disableDepthTestDistance: Number.POSITIVE_INFINITY,
      scaleByDistance: new Cesium.NearFarScalar(1e6, 1.0, 2e7, 0.4)
    },
    properties: { data: hs, type: hs.type, isCustom }
  });
  return entity;
}

HOTSPOTS.forEach(hs => addMarker(hs));

// ‚îÄ‚îÄ HOVER / CLICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const infocard = document.getElementById('infocard');
const icLbl = document.getElementById('ic-lbl');
const icTtl = document.getElementById('ic-ttl');
const icBody = document.getElementById('ic-body');
const icMkt  = document.getElementById('ic-mkt');
const icTags = document.getElementById('ic-tags');

function showCard(data, x, y) {
  icLbl.textContent = `${(data.type||'').toUpperCase()} ¬∑ ${(data.sev||'').toUpperCase()} ¬∑ ${data.lat.toFixed(1)}¬∞N ${data.lon.toFixed(1)}¬∞E`;
  icTtl.textContent = data.title;
  icBody.textContent = data.body;
  icMkt.textContent  = data.mkt ? `üìä Market: ${data.mkt}` : '';
  icTags.innerHTML   = (data.tags||[]).map(t=>`<span class="ic-tag">${t}</span>`).join('');
  infocard.className = `show ${data.sev||''}`;
  const cx = Math.min(x+16, window.innerWidth-330);
  const cy = Math.min(y-10, window.innerHeight-220);
  infocard.style.left = cx+'px';
  infocard.style.top  = cy+'px';
}

function hideCard() { infocard.className=''; hoveredEntity=null; }

document.addEventListener('mousemove', e => {
  mouseX = e.clientX; mouseY = e.clientY;
  const picked = viewer.scene.pick(new Cesium.Cartesian2(e.clientX, e.clientY));
  if (Cesium.defined(picked) && picked.id && picked.id.properties) {
    const data = picked.id.properties.data.getValue();
    hoveredEntity = picked.id;
    showCard(data, e.clientX, e.clientY);
    viewer.canvas.style.cursor = 'crosshair';
  } else {
    hideCard();
    viewer.canvas.style.cursor = 'grab';
  }
});

const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
handler.setInputAction(click => {
  const picked = viewer.scene.pick(click.position);
  if (Cesium.defined(picked) && picked.id && picked.id.properties) {
    const data = picked.id.properties.data.getValue();
    showCard(data, click.position.x, click.position.y);
    // Fly to location
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(data.lon, data.lat-5, 4000000),
      duration: 1.5,
      orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }
    });
  } else { hideCard(); }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

// ‚îÄ‚îÄ FILTER BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.fbtn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.f;
    viewer.entities.values.forEach(e => {
      if (!e.properties) return;
      const t = e.properties.type ? e.properties.type.getValue() : '';
      const isC = e.properties.isCustom ? e.properties.isCustom.getValue() : false;
      if (activeFilter === 'all') e.show = true;
      else if (activeFilter === 'custom') e.show = isC;
      else e.show = t === activeFilter;
    });
  });
});

// ‚îÄ‚îÄ THEATER PANEL CLICKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tpi').forEach(el => {
  el.addEventListener('click', () => {
    const lat = parseFloat(el.dataset.lat);
    const lon = parseFloat(el.dataset.lon);
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(lon, lat-8, 5000000),
      duration: 2.0,
      orientation: { heading: 0, pitch: Cesium.Math.toRadians(-40), roll: 0 }
    });
  });
});

// ‚îÄ‚îÄ ADD CUSTOM EVENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAdd() { document.getElementById('adddlg').classList.add('show'); }
function closeAdd() { document.getElementById('adddlg').classList.remove('show'); }

function addEvent() {
  const title = document.getElementById('ev-title').value;
  const lat   = parseFloat(document.getElementById('ev-lat').value);
  const lon   = parseFloat(document.getElementById('ev-lon').value);
  const desc  = document.getElementById('ev-desc').value;
  const sev   = document.getElementById('ev-sev').value;
  const mkt   = document.getElementById('ev-mkt').value;
  if (!title || isNaN(lat) || isNaN(lon)) { alert('Please fill in title, latitude, and longitude.'); return; }
  const ev = { lat, lon, label: title.substring(0,12).toUpperCase(), sev, type:'custom',
               title, body: desc, mkt, tags:['CUSTOM','USER-ADDED'], isCustom:true };
  customEvents.push(ev);
  addMarker(ev, true);
  const list = document.getElementById('addedlist');
  const item = document.createElement('div');
  item.className = 'added-event';
  item.textContent = `‚óâ ${title.substring(0,25)}`;
  item.onclick = () => viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(lon, lat-5, 4000000), duration: 1.5,
    orientation: { heading:0, pitch:Cesium.Math.toRadians(-45), roll:0 }
  });
  list.appendChild(item);
  closeAdd();
  ['ev-title','ev-lat','ev-lon','ev-desc','ev-mkt'].forEach(id=>document.getElementById(id).value='');
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const now = new Date();
  const pst = new Date(now.toLocaleString('en-US',{timeZone:'America/Los_Angeles'}));
  const pad = n => String(n).padStart(2,'0');
  document.getElementById('clocktxt').textContent = `${pad(pst.getHours())}:${pad(pst.getMinutes())}:${pad(pst.getSeconds())} PST`;
}
setInterval(updateClock,1000); updateClock();

// ‚îÄ‚îÄ PULSE ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let t = 0;
viewer.clock.shouldAnimate = false;
function animatePulse() {
  requestAnimationFrame(animatePulse);
  t += 0.02;
  viewer.entities.values.forEach(e => {
    if (!e.point || !e.properties) return;
    const sev = e.properties.data ? e.properties.data.getValue().sev : 'watch';
    const base = sev==='critical' ? 10 : sev==='elevated' ? 8 : 7;
    const pulse = base + Math.sin(t*(sev==='critical'?4:2.5))*3;
    e.point.pixelSize = pulse;
    const alpha = 0.15 + Math.abs(Math.sin(t*(sev==='critical'?3:2)))*0.25;
    const clr = Cesium.Color.fromCssColorString(COLORS[sev]||'#4fc3f7');
    e.point.outlineColor = clr.withAlpha(alpha);
    e.point.outlineWidth = 8 + Math.abs(Math.sin(t*2))*4;
  });
}
animatePulse();
</script>
</body>
</html>

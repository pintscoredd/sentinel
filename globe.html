<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>SENTINEL GEO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Courier New', monospace;
    }

    html,
    body {
      background: #000;
      color: #d0d3d8;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #c {
      display: block;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Header */
    #hdr {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      background: linear-gradient(180deg, rgba(0, 0, 0, .95) 0%, transparent 100%);
      padding: 6px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    #logo {
      color: #FF6600;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 3px;
    }

    #hst {
      font-size: 9px;
      color: #444;
      display: flex;
      gap: 10px;
    }

    .hd {
      display: inline-block;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      margin-right: 3px;
      vertical-align: middle;
    }

    .hg {
      background: #00CC44;
      animation: pb 2s infinite;
    }

    .ha {
      background: #FF6600;
    }

    .hr {
      background: #FF4444;
      animation: pb 1s infinite;
    }

    @keyframes pb {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .2
      }
    }

    /* Filter bar */
    #fb {
      position: absolute;
      left: 8px;
      top: 42px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 2px;
      pointer-events: all;
    }

    .fbtn {
      background: rgba(0, 0, 0, .9);
      border: 1px solid #1a1a1a;
      color: #555;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      letter-spacing: 1px;
      padding: 6px 12px;
      cursor: pointer;
      width: 155px;
      text-align: left;
      transition: all .15s;
    }

    .fbtn:hover,
    .fbtn.on {
      background: rgba(255, 102, 0, .12);
      border-color: #FF6600;
      color: #FF6600;
    }

    /* Theater panel */
    #tp {
      position: absolute;
      right: 0;
      top: 42px;
      width: 215px;
      background: rgba(0, 0, 0, .96);
      border: 1px solid #222;
      border-right: none;
      z-index: 20;
    }

    .tph {
      padding: 8px 11px;
      font-size: 11px;
      letter-spacing: 2px;
      color: #FF6600;
      border-bottom: 1px solid #222;
      font-weight: 700;
    }

    .tpi {
      padding: 10px 11px;
      border-bottom: 1px solid #151515;
      cursor: pointer;
      transition: all .15s;
      border-left: 3px solid transparent;
      pointer-events: all;
    }

    .tpi:hover {
      background: rgba(255, 102, 0, .1);
      border-left-color: #FF6600;
    }

    .tpn {
      font-size: 13px;
      color: #ddd;
      font-weight: 700;
    }

    .tps {
      font-size: 11px;
      margin-top: 2px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .tc {
      color: #FF4444;
    }

    .te {
      color: #FF8C00;
    }

    .tw {
      color: #FFCC00;
    }

    /* Info card popup */
    #ic {
      position: absolute;
      z-index: 50;
      background: rgba(0, 0, 2, .98);
      border: 1px solid #2a2a2a;
      border-left: 4px solid #FF6600;
      padding: 15px 17px;
      width: 300px;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, .9);
    }

    #ic.show {
      display: block;
    }

    #ic.critical {
      border-left-color: #FF4444;
    }

    #ic.elevated {
      border-left-color: #FF6600;
    }

    #ic.watch {
      border-left-color: #FFCC00;
    }

    #ic-close {
      position: absolute;
      top: 7px;
      right: 9px;
      cursor: pointer;
      color: #444;
      font-size: 16px;
      line-height: 1;
      transition: color .15s;
    }

    #ic-close:hover {
      color: #FF6600;
    }

    .icl {
      font-size: 8px;
      letter-spacing: 2px;
      color: #444;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .ict {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 7px;
      line-height: 1.35;
    }

    .icb {
      font-size: 11px;
      color: #999;
      line-height: 1.75;
    }

    .icm {
      color: #00AAFF;
      margin-top: 7px;
      font-size: 11px;
      font-weight: 600;
    }

    .ictags {
      margin-top: 7px;
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
    }

    .ictag {
      font-size: 8px;
      padding: 1px 5px;
      border: 1px solid #252525;
      color: #555;
      letter-spacing: 1px;
    }

    /* Add event */
    #addbtn {
      position: absolute;
      right: 225px;
      bottom: 42px;
      z-index: 20;
      background: rgba(255, 102, 0, .1);
      border: 1px solid #FF6600;
      color: #FF6600;
      font-family: 'Courier New', monospace;
      font-size: 9px;
      padding: 4px 10px;
      cursor: pointer;
      letter-spacing: 1px;
    }

    #addbtn:hover {
      background: rgba(255, 102, 0, .2);
    }

    #adddlg {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #060606;
      border: 1px solid #FF6600;
      padding: 18px;
      width: 320px;
      z-index: 60;
      display: none;
    }

    #adddlg.show {
      display: block;
    }

    #adddlg h3 {
      color: #FF6600;
      font-size: 10px;
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    #adddlg label {
      font-size: 9px;
      color: #666;
      display: block;
      margin-bottom: 2px;
      letter-spacing: 1px;
    }

    #adddlg input,
    #adddlg select,
    #adddlg textarea {
      width: 100%;
      background: #000;
      border: 1px solid #1a1a1a;
      color: #ccc;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      padding: 4px 7px;
      margin-bottom: 8px;
    }

    .dbtns {
      display: flex;
      gap: 7px;
      margin-top: 3px;
    }

    .dbok {
      flex: 1;
      padding: 5px;
      font-family: 'Courier New', monospace;
      font-size: 9px;
      cursor: pointer;
      border: 1px solid #FF6600;
      background: rgba(255, 102, 0, .15);
      color: #FF6600;
    }

    .dbcancel {
      flex: 1;
      padding: 5px;
      font-family: 'Courier New', monospace;
      font-size: 9px;
      cursor: pointer;
      border: 1px solid #1a1a1a;
      background: transparent;
      color: #555;
    }

    /* Status bar */
    #sb {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 3px 12px;
      display: flex;
      justify-content: space-between;
      background: linear-gradient(0deg, rgba(0, 0, 0, .95) 0%, transparent 100%);
      z-index: 20;
      font-size: 8px;
      letter-spacing: 1px;
      color: #2a2a2a;
      pointer-events: none;
    }

    /* Tooltip */
    #tt {
      position: absolute;
      z-index: 30;
      background: rgba(0, 0, 0, .92);
      border: 1px solid #FF6600;
      padding: 3px 7px;
      font-size: 9px;
      color: #FF8C00;
      display: none;
      pointer-events: none;
      white-space: nowrap;
    }

    /* Loader */
    #ls {
      position: absolute;
      inset: 0;
      background: #000005;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
    }

    #ls.gone {
      display: none;
    }

    .lt {
      color: #FF6600;
      font-size: 10px;
      letter-spacing: 4px;
      animation: pb 1.5s infinite;
    }

    .lb {
      width: 180px;
      height: 2px;
      background: #111;
      overflow: hidden;
    }

    .lb::after {
      content: '';
      display: block;
      width: 40%;
      height: 100%;
      background: #FF6600;
      animation: sl 1.1s linear infinite;
    }

    @keyframes sl {
      0% {
        transform: translateX(-100%)
      }

      100% {
        transform: translateX(350%)
      }
    }
  </style>
</head>

<body>
  <div id="ls">
    <div style="color:#FF6600;font-size:18px;font-weight:900;letter-spacing:5px">‚ö° SENTINEL GEO</div>
    <div class="lt">LOADING GEOPOLITICAL LAYER‚Ä¶</div>
    <div class="lb"></div>
  </div>

  <canvas id="c"></canvas>

  <div id="hdr">
    <div><span id="logo">‚ö° SENTINEL GEO</span><span style="color:#2a2a2a;font-size:8px;margin-left:10px">GEOPOLITICAL
        INTELLIGENCE</span></div>
    <div id="hst">
      <span><span class="hd hg"></span>LIVE</span>
      <span><span class="hd hg"></span>GDELT</span>
      <span><span class="hd ha"></span>AIS</span>
      <span id="clk" style="color:#333"></span>
    </div>
  </div>

  <div id="fb">
    <button class="fbtn on" onclick="setFilter('all',this)">‚óè ALL EVENTS</button>
    <button class="fbtn" onclick="setFilter('conflict',this)">‚óÜ CONFLICT</button>
    <button class="fbtn" onclick="setFilter('energy',this)">‚¨° ENERGY</button>
    <button class="fbtn" onclick="setFilter('shipping',this)">‚óà SHIPPING</button>
    <button class="fbtn" onclick="setFilter('minerals',this)">‚¨ü MINERALS</button>
    <button class="fbtn" onclick="setFilter('trade',this)">‚óá TRADE/TECH</button>
    <button class="fbtn" onclick="setFilter('custom',this)">+ MY EVENTS</button>
  </div>

  <div id="tp">
    <div class="tph">‚ö† THEATER STATUS</div>
    <div class="tpi" onclick="flyToTheater(31.5,34.8,'MIDDLE EAST')">
      <div class="tpn">MIDDLE EAST</div>
      <div class="tps tc">‚óè CRITICAL</div>
    </div>
    <div class="tpi" onclick="flyToTheater(49,31,'UKRAINE')">
      <div class="tpn">UKRAINE</div>
      <div class="tps tc">‚óè ACTIVE</div>
    </div>
    <div class="tpi" onclick="flyToTheater(14,43,'RED SEA')">
      <div class="tpn">RED SEA</div>
      <div class="tps tc">‚óè DISRUPTED</div>
    </div>
    <div class="tpi" onclick="flyToTheater(26.5,56,'HORMUZ')">
      <div class="tpn">HORMUZ</div>
      <div class="tps te">‚óè ELEVATED</div>
    </div>
    <div class="tpi" onclick="flyToTheater(14,2,'SAHEL')">
      <div class="tpn">SAHEL</div>
      <div class="tps te">‚óè ELEVATED</div>
    </div>
    <div class="tpi" onclick="flyToTheater(25,121,'TAIWAN')">
      <div class="tpn">TAIWAN</div>
      <div class="tps tw">‚óè MONITORING</div>
    </div>
    <div class="tpi" onclick="flyToTheater(12,115,'S. CHINA SEA')">
      <div class="tpn">S. CHINA SEA</div>
      <div class="tps tw">‚óè MONITORING</div>
    </div>
  </div>

  <div id="ic">
    <span id="ic-close" onclick="closeCard()">‚úï</span>
    <div class="icl" id="ic-sev"></div>
    <div class="ict" id="ic-ttl"></div>
    <div class="icb" id="ic-body"></div>
    <div class="icm" id="ic-mkt"></div>
    <div class="ictags" id="ic-tags"></div>
    <div id="ic-date" style="color:#555;font-size:9px;margin-top:6px;letter-spacing:1px"></div>
  </div>

  <!-- Live news feed panel -->
  <div id="newsfeed"
    style="position:absolute;bottom:38px;left:10px;z-index:20;width:520px;font-family:'Courier New',monospace">
    <div style="color:#FF6600;font-size:11px;letter-spacing:2px;margin-bottom:6px;font-weight:700">üì° LIVE INTEL FEED
    </div>
    <div id="nf-items" style="font-size:13px"></div>
  </div>
  <div id="tt"></div>

  <button id="addbtn" onclick="document.getElementById('adddlg').classList.add('show')">Ôºã ADD EVENT</button>
  <div id="adddlg">
    <h3>ADD CUSTOM EVENT</h3>
    <label>TITLE</label><input id="ae-title" placeholder="e.g. Belarus Tensions">
    <label>LAT / LON</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px">
      <input id="ae-lat" placeholder="e.g. 52.0">
      <input id="ae-lon" placeholder="e.g. 28.0">
    </div>
    <label>DESCRIPTION</label><textarea id="ae-desc" rows="3" placeholder="Intel summary‚Ä¶"></textarea>
    <label>SEVERITY</label>
    <select id="ae-sev">
      <option value="critical">CRITICAL</option>
      <option value="elevated">ELEVATED</option>
      <option value="watch">WATCH</option>
    </select>
    <label>MARKET IMPACT</label><input id="ae-mkt" placeholder="e.g. XLE, WTI Crude">
    <div class="dbtns">
      <button class="dbok" onclick="addCustomEvent()">CONFIRM</button>
      <button class="dbcancel" onclick="document.getElementById('adddlg').classList.remove('show')">CANCEL</button>
    </div>
  </div>

  <div id="sb">
    <div><span class="hd hr" style="display:inline-block;margin-right:4px"></span>3 CRITICAL &nbsp;<span class="hd ha"
        style="display:inline-block;margin-right:4px;margin-left:8px"></span>4 ELEVATED</div>
    <div>DRAG TO ROTATE ¬∑ SCROLL TO ZOOM ¬∑ CLICK MARKERS FOR INTEL</div>
    <div>THREE.JS ¬∑ GDELT ¬∑ AIS ¬∑ NASA</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // ‚îÄ‚îÄ CLOCK
    setInterval(() => {
      const d = new Date();
      const el = document.getElementById('clk');
      if (el) el.textContent = d.toUTCString().slice(17, 25) + ' UTC';
    }, 1000);

    // ‚îÄ‚îÄ CANVAS SIZE (use actual canvas dimensions for correct picking)
    const canvas = document.getElementById('c');
    let CW = canvas.offsetWidth || window.innerWidth;
    let CH = canvas.offsetHeight || window.innerHeight;
    if (CW < 10) CW = window.innerWidth;
    if (CH < 10) CH = window.innerHeight;

    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: false });
    renderer.setSize(CW, CH);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setClearColor(0x000003);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(42, CW / CH, 0.1, 1000);
    camera.position.set(0, 0, 2.65);

    // ‚îÄ‚îÄ GLOBE SETUP (reduced poly for performance)
    const globeGeo = new THREE.SphereGeometry(1, 64, 64);
    const loader = new THREE.TextureLoader();
    let globeMesh = null;
    let earthTex = null;

    // ‚îÄ‚îÄ REALISTIC DARK OCEAN FALLBACK TEXTURE
    function makeFallback() {
      const cv = document.createElement('canvas');
      cv.width = 2048; cv.height = 1024;
      const ctx = cv.getContext('2d');

      // Very dark deep ocean ‚Äî near-black for maximum contrast
      const og = ctx.createLinearGradient(0, 0, 0, 1024);
      og.addColorStop(0, '#000308');
      og.addColorStop(.4, '#00050c');
      og.addColorStop(.6, '#00050c');
      og.addColorStop(1, '#000308');
      ctx.fillStyle = og; ctx.fillRect(0, 0, 2048, 1024);

      // Subtle ocean depth variation (nearly invisible abyssal plains)
      ctx.fillStyle = 'rgba(0,4,12,0.4)';
      // Pacific deep
      ctx.fillRect(850, 150, 500, 700);
      // Atlantic deep
      ctx.fillRect(400, 200, 120, 600);

      // Continental shelf highlights (very subtle near coasts)
      ctx.fillStyle = 'rgba(2,12,30,0.25)';

      // Continents ‚Äî realistic shapes
      ctx.fillStyle = '#1d3c18';

      // North America
      const na = [
        [290, 190, 175, 130, -.1], [245, 285, 110, 95, .05], [215, 335, 70, 58, 0],
        [370, 270, 90, 68, -.08], [295, 150, 60, 45, .1], [260, 125, 45, 30, .05]
      ];
      // South America
      const sa = [
        [325, 475, 105, 80, .08], [298, 550, 85, 98, -.04], [308, 618, 68, 75, -.08]
      ];
      // Europe
      const eu = [
        [610, 200, 92, 68, .04], [658, 232, 62, 50, -.08], [636, 182, 52, 40, .12],
        [590, 188, 30, 22, .05], [630, 155, 28, 18, .1], [665, 170, 22, 18, -.05]
      ];
      // Africa
      const af = [
        [628, 342, 108, 98, .03], [618, 428, 98, 108, -.04], [608, 508, 78, 88, 0], [600, 582, 58, 54, .08]
      ];
      // Asia
      const as = [
        [718, 192, 145, 108, .08], [825, 212, 128, 95, -.04], [882, 252, 108, 82, .04],
        [925, 292, 92, 74, -.08], [968, 192, 88, 64, .08], [1015, 278, 78, 64, -.08],
        [845, 172, 65, 54, .18], [870, 148, 48, 35, .1]
      ];
      // Japan
      const jp = [[982, 228, 16, 42, .18], [992, 255, 11, 28, .18]];
      // SE Asia
      const sea = [[922, 375, 72, 58, .04], [962, 418, 58, 44, -.08]];
      // Australia
      const au = [[908, 508, 98, 65, .04], [928, 562, 74, 54, -.08]];
      // Greenland
      const gr = [[362, 136, 70, 48, .08], [332, 126, 44, 34, .12]];
      // UK
      const uk = [[592, 192, 18, 26, .08], [607, 188, 12, 20, .1]];
      // Madagascar
      const ma = [[660, 470, 18, 38, .1]];

      [na, sa, eu, af, as, jp, sea, au, gr, uk, ma].flat().forEach(([x, y, w, h, r = 0]) => {
        ctx.save(); ctx.translate(x, y); ctx.rotate(r);
        ctx.beginPath(); ctx.ellipse(0, 0, w, h, 0, 0, Math.PI * 2);
        ctx.fill(); ctx.restore();
      });

      // Mountain ranges (darker green-grey)
      ctx.fillStyle = '#162a13';
      [[718, 208, 26, 16], [690, 220, 20, 12], [885, 222, 18, 11], [310, 230, 20, 12]].forEach(([x, y, w, h]) => {
        ctx.beginPath(); ctx.ellipse(x, y, w, h, 0, 0, Math.PI * 2); ctx.fill();
      });

      // Deserts (pale ochre tint)
      ctx.fillStyle = 'rgba(80,60,20,0.18)';
      [[635, 375, 75, 48], [910, 295, 55, 38]].forEach(([x, y, w, h]) => {
        ctx.beginPath(); ctx.ellipse(x, y, w, h, 0, 0, Math.PI * 2); ctx.fill();
      });

      // Arctic ice ‚Äî bluish white
      ctx.fillStyle = '#c0d8e8';
      ctx.fillRect(0, 0, 2048, 18);
      ctx.fillRect(0, 1000, 2048, 24);
      ctx.fillStyle = 'rgba(170,200,220,0.55)';
      ctx.fillRect(0, 18, 2048, 15);
      ctx.fillRect(0, 985, 2048, 16);

      return new THREE.CanvasTexture(cv);
    }

    function buildGlobe() {
      const mat = new THREE.MeshPhongMaterial({
        map: earthTex || makeFallback(),
        color: new THREE.Color(0x8899bb),          // Bright tint ‚Äî lets blue marble show naturally
        specular: new THREE.Color(0x334466),        // Subtle ocean reflections
        shininess: 15,
        emissive: new THREE.Color(0x020815),
        emissiveIntensity: 0.08,
      });
      if (globeMesh) scene.remove(globeMesh);
      globeMesh = new THREE.Mesh(globeGeo, mat);
      scene.add(globeMesh);
      document.getElementById('ls').classList.add('gone');
    }

    // Build immediately with fallback, upgrade if texture loads
    buildGlobe();
    loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
      t => { earthTex = t; buildGlobe(); }, undefined, () => { });
    setTimeout(() => document.getElementById('ls').classList.add('gone'), 2000);

    // ‚îÄ‚îÄ ATMOSPHERE ‚Äî single dark navy glow (reduced from 2 layers)
    const atm1 = new THREE.MeshPhongMaterial({ color: 0x000d1f, transparent: true, opacity: 0.10, side: THREE.FrontSide, depthWrite: false, blending: THREE.AdditiveBlending });
    scene.add(new THREE.Mesh(new THREE.SphereGeometry(1.02, 32, 32), atm1));
    // Grid overlay
    scene.add(new THREE.Mesh(new THREE.SphereGeometry(1.001, 24, 12), new THREE.MeshBasicMaterial({ color: 0x000a14, wireframe: true, transparent: true, opacity: 0.025 })));

    // ‚îÄ‚îÄ LIGHTING ‚Äî bright natural earth
    scene.add(new THREE.AmbientLight(0x334455, 1.2));           // Strong ambient for visibility
    const sun = new THREE.DirectionalLight(0xfff8ee, 2.5);      // Bright warm sun
    sun.position.set(6, 2, 4); scene.add(sun);
    const fill = new THREE.DirectionalLight(0x2a3a50, 0.8);     // Strong fill for dark side
    fill.position.set(-6, -2, -4); scene.add(fill);
    const rim = new THREE.DirectionalLight(0x2a3545, 0.6);      // Rim light
    rim.position.set(-2, 1, -5); scene.add(rim);

    // ‚îÄ‚îÄ STARS
    const sg = new THREE.BufferGeometry(), sp = [], sc = [];
    for (let i = 0; i < 2000; i++) {
      const th = Math.random() * Math.PI * 2, ph = Math.acos(2 * Math.random() - 1), r = 65 + Math.random() * 85;
      sp.push(r * Math.sin(ph) * Math.cos(th), r * Math.cos(ph), r * Math.sin(ph) * Math.sin(th));
      const t = Math.random();
      if (t < .08) sc.push(.6, .6, 1.0);       // blue giants
      else if (t < .16) sc.push(1.0, .85, .6); // yellow
      else if (t < .20) sc.push(1.0, .6, .5);  // red dwarf
      else sc.push(.4, .45, .55);            // white-grey
    }
    sg.setAttribute('position', new THREE.Float32BufferAttribute(sp, 3));
    sg.setAttribute('color', new THREE.Float32BufferAttribute(sc, 3));
    scene.add(new THREE.Points(sg, new THREE.PointsMaterial({ size: .11, vertexColors: true })));

    // ‚îÄ‚îÄ HOTSPOT DATA
    const HOTSPOTS = [
      {
        lat: 31.5, lon: 34.8, label: 'GAZA/ISRAEL', sev: 'critical', type: 'conflict',
        title: 'Gaza ‚Äî Active Conflict Zone',
        body: 'Ongoing operations in Gaza. Regional escalation risk via Hezbollah and IRGC proxies. US carrier strike group in Eastern Mediterranean. Iran-backed network spanning 5 countries.',
        mkt: 'WTI (CL=F), Gold (GLD), XLE, ITA, LMT', tags: ['OIL RISK', 'IRGC', 'ESCALATION']
      },
      {
        lat: 14, lon: 43, label: 'RED SEA', sev: 'critical', type: 'shipping',
        title: 'Red Sea ‚Äî Houthi Shipping Campaign',
        body: 'Houthi ballistic/drone attacks on commercial vessels ongoing. Cape of Good Hope rerouting adds 12‚Äì14 days. Suez Canal transits down ~40%. Container rates +35% vs pre-crisis.',
        mkt: 'Container ETFs, FDX, UPS, European CPI, XLE', tags: ['SHIPPING', 'HOUTHI', 'INFLATION']
      },
      {
        lat: 26.5, lon: 56, label: 'HORMUZ', sev: 'elevated', type: 'energy',
        title: 'Strait of Hormuz ‚Äî IRGC Naval Ops',
        body: "20% of global oil transits Hormuz daily. IRGC elevated naval presence. Lloyd's war risk premiums +300%. Tanker insurance spiking sharply.",
        mkt: "WTI (CL=F), Brent, XLE, Airline margins", tags: ["20% GLOBAL OIL", "IRAN", "IRGC"]
      },
      {
        lat: 25, lon: 121, label: 'TAIWAN', sev: 'elevated', type: 'trade',
        title: 'Taiwan Strait ‚Äî PLA Military Posture',
        body: 'PLA conducting regular exercises near median line. TSMC produces 90%+ of advanced chips <5nm. US carrier groups in Western Pacific. AUKUS submarine deliveries accelerating.',
        mkt: 'SMH, NVDA, AAPL supply chain, SOXX, TSM', tags: ['TSMC', 'SEMICONDUCTORS', 'PLA']
      },
      {
        lat: 49, lon: 31, label: 'UKRAINE', sev: 'critical', type: 'conflict',
        title: 'Ukraine ‚Äî Active War Theater',
        body: 'Frontline active across 1,000km line. Russia targeting power/energy infrastructure. NATO Patriot deployments expanding. Grain corridor disrupted.',
        mkt: 'NG=F (natgas), ZW=F (wheat), European banks, Defense ETFs', tags: ['NATGAS', 'GRAIN', 'NATO']
      },
      {
        lat: 14, lon: 2, label: 'SAHEL', sev: 'elevated', type: 'minerals',
        title: 'Sahel ‚Äî Coups & Critical Minerals',
        body: 'Coup governments in Mali, Niger, Burkina Faso. French forces withdrawn. Wagner/Africa Corps active. Chinese mining rights expanding in gold/lithium zones.',
        mkt: 'GDX, SIL, LIT, gold futures', tags: ['GOLD', 'LITHIUM', 'WAGNER']
      },
      {
        lat: -5, lon: 23.5, label: 'DRC/COBALT', sev: 'elevated', type: 'minerals',
        title: 'DRC ‚Äî Cobalt Supply Chain',
        body: 'DRC produces ~70% of world cobalt. M23 rebels active near Goma. Eastern DRC conflict threatening mining operations. Chinese firms control ~80% of processing capacity.',
        mkt: 'Cobalt, TSLA supply chain, ALB, SQM, LIT', tags: ['70% COBALT', 'EV', 'M23']
      },
      {
        lat: 12, lon: 115, label: 'S CHINA SEA', sev: 'elevated', type: 'shipping',
        title: 'South China Sea ‚Äî Territorial Disputes',
        body: '$3T+ annual trade transits here. Philippines-China confrontations at Second Thomas Shoal escalating. Water cannon incidents. US-Philippines military exercises intensifying.',
        mkt: 'Container shipping, Asian FX, semiconductors', tags: ['$3T TRADE', 'NAVAL', 'PHILIPPINES']
      },
      {
        lat: 56, lon: 37.6, label: 'RUSSIA', sev: 'elevated', type: 'energy',
        title: 'Russia ‚Äî Energy Export Rerouting',
        body: 'Russian oil rerouted to China/India at 15‚Äì20% discount. European LNG costs remain elevated. Sanctions enforcement tightening. Shadow fleet growing to ~500 vessels.',
        mkt: 'European natgas, LNG stocks, UNG, XLE', tags: ['LNG', 'SANCTIONS', 'SHADOW FLEET']
      },
      {
        lat: 35.6, lon: 139.7, label: 'BOJ/YEN', sev: 'watch', type: 'trade',
        title: 'Japan ‚Äî BOJ Policy & Yen Carry Trade',
        body: 'BOJ normalizing ultra-loose policy after 3 decades. Yen carry trade unwind risk ‚Äî estimated $4T+ in positions. Rate hike trajectory uncertain ‚Äî global volatility trigger.',
        mkt: 'USD/JPY, Nikkei, DXY, global bonds, TLT', tags: ['YEN CARRY', 'BOJ', 'REFLATION']
      },
      {
        lat: -20, lon: 28, label: 'ZIMBABWE', sev: 'watch', type: 'minerals',
        title: 'Zimbabwe ‚Äî Lithium Export Controls',
        body: 'Zimbabwe banned raw lithium ore exports. Chinese firms dominate local processing. EV battery supply chain implications for Tesla, BYD. ALB/SQM affected.',
        mkt: 'LIT, ALB (Albemarle), SQM, LTHM', tags: ['LITHIUM', 'EV', 'EXPORT BAN']
      },
      {
        lat: 33, lon: 44, label: 'IRAQ/IRAN', sev: 'elevated', type: 'energy',
        title: 'Iraq ‚Äî Iranian Proxy Network',
        body: 'Iranian-backed militias targeted 160+ US facilities since Oct 2023. Iraqi oil output near record 4.3Mbpd. OPEC+ compliance and Iran nuclear talks create complex dynamics.',
        mkt: 'WTI, Brent, XLE, OIH', tags: ['IRAN PROXIES', 'OPEC+', 'OIL']
      },
    ];

    const COLORS = { critical: '#FF4444', elevated: '#FF8C00', watch: '#FFCC00' };
    let customEvents = [], activeFilter = 'all';
    let autoRotate = true, dragging = false, isDrag = false, dragDist = 0;
    let prevX = 0, prevY = 0, rotX = 0, rotY = 0, targetRotX = 0, targetRotY = 0;
    const markers = [];

    // ‚îÄ‚îÄ COORDINATE CONVERSION
    function latLonToVec3(lat, lon, r = 1.013) {
      const phi = (90 - lat) * Math.PI / 180;
      const theta = (lon + 180) * Math.PI / 180;
      return new THREE.Vector3(
        -r * Math.sin(phi) * Math.cos(theta),
        r * Math.cos(phi),
        r * Math.sin(phi) * Math.sin(theta)
      );
    }

    // ‚îÄ‚îÄ MARKERS
    function makeMarker(h) {
      const col = COLORS[h.sev] || '#FF6600';
      const c = new THREE.Color(col);
      const pos = latLonToVec3(h.lat, h.lon);

      const mesh = new THREE.Mesh(
        new THREE.SphereGeometry(0.023, 16, 16),
        new THREE.MeshBasicMaterial({ color: c })
      );
      mesh.position.copy(pos); mesh.userData = { hotspot: h };

      const glow = new THREE.Mesh(
        new THREE.SphereGeometry(0.042, 16, 16),
        new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: 0.10, side: THREE.FrontSide })
      );
      glow.position.copy(pos); glow.userData = { hotspot: h };

      const ring = new THREE.Mesh(
        new THREE.RingGeometry(0.030, 0.040, 32),
        new THREE.MeshBasicMaterial({ color: c, transparent: true, opacity: 0.55, side: THREE.DoubleSide })
      );
      ring.position.copy(pos); ring.lookAt(0, 0, 0); ring.rotateX(Math.PI / 2);
      ring.userData = { phase: Math.random() * Math.PI * 2 };

      scene.add(ring); scene.add(glow); scene.add(mesh);
      markers.push({ mesh, ring, glow, hotspot: h, basePos: pos.clone() });
    }

    function renderMarkers() {
      markers.forEach(({ mesh, ring, glow }) => { scene.remove(mesh); scene.remove(ring); scene.remove(glow); });
      markers.length = 0;
      HOTSPOTS.filter(h => activeFilter === 'all' || h.type === activeFilter).forEach(makeMarker);
      if (activeFilter === 'custom' || activeFilter === 'all') customEvents.forEach(makeMarker);
    }
    renderMarkers();

    // ‚îÄ‚îÄ RAYCASTING & INTERACTION
    const raycaster = new THREE.Raycaster();
    raycaster.params.Mesh = { backfaceCulling: false };
    const mouse = new THREE.Vector2();

    function getCanvasXY(e) {
      const r = canvas.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top, cx: e.clientX, cy: e.clientY };
    }

    function canvasToNDC(x, y) {
      const W = canvas.clientWidth || CW, H = canvas.clientHeight || CH;
      return { x: (x / W) * 2 - 1, y: -(y / H) * 2 + 1 };
    }

    canvas.addEventListener('mousedown', e => {
      dragging = true; isDrag = false; dragDist = 0; autoRotate = false;
      const p = getCanvasXY(e); prevX = p.x; prevY = p.y;
    });
    canvas.addEventListener('mouseup', () => { dragging = false; });

    canvas.addEventListener('mousemove', e => {
      const p = getCanvasXY(e);
      if (dragging) {
        const dx = p.x - prevX, dy = p.y - prevY;
        dragDist += Math.abs(dx) + Math.abs(dy);
        if (dragDist > 5) isDrag = true;
        targetRotY += dx * 0.005; targetRotX += dy * 0.004;
        targetRotX = Math.max(-Math.PI / 2.1, Math.min(Math.PI / 2.1, targetRotX));
        prevX = p.x; prevY = p.y;
      }
      // Hover tooltip
      const ndc = canvasToNDC(p.x, p.y);
      mouse.x = ndc.x; mouse.y = ndc.y;
      raycaster.setFromCamera(mouse, camera);
      const allM = markers.flatMap(m => [m.mesh, m.glow]).filter(Boolean);
      const hits = raycaster.intersectObjects(allM);
      const tt = document.getElementById('tt');
      if (hits.length && hits[0].object.userData.hotspot) {
        const h = hits[0].object.userData.hotspot;
        tt.style.display = 'block';
        tt.style.left = (p.x + 14) + 'px'; tt.style.top = (p.y - 6) + 'px';
        tt.textContent = h.label + ' ‚Äî ' + h.sev.toUpperCase();
        canvas.style.cursor = 'pointer';
      } else {
        tt.style.display = 'none'; canvas.style.cursor = 'default';
      }
    });

    canvas.addEventListener('click', e => {
      if (isDrag) return;
      const p = getCanvasXY(e);
      const ndc = canvasToNDC(p.x, p.y);
      mouse.x = ndc.x; mouse.y = ndc.y;
      raycaster.setFromCamera(mouse, camera);
      const allM = markers.flatMap(m => [m.mesh, m.glow]).filter(Boolean);
      const hits = raycaster.intersectObjects(allM);
      if (hits.length && hits[0].object.userData.hotspot) {
        showCard(hits[0].object.userData.hotspot, p.x, p.y);
      } else {
        closeCard();
      }
    });

    function closeCard() {
      const ic = document.getElementById('ic');
      ic.style.display = 'none'; ic.className = '';
    }

    function showCard(h, px, py) {
      const ic = document.getElementById('ic');
      const W = canvas.clientWidth || CW, H = canvas.clientHeight || CH;
      const IW = 300; const IH = 240; // approx popup size

      document.getElementById('ic-sev').textContent = h.sev.toUpperCase() + ' ‚Äî ' + h.type.toUpperCase();
      document.getElementById('ic-ttl').textContent = h.title || h.label;
      document.getElementById('ic-body').textContent = h.body || '';
      document.getElementById('ic-mkt').textContent = h.mkt ? 'üìä MARKET: ' + h.mkt : '';
      document.getElementById('ic-tags').innerHTML = (h.tags || []).map(t => `<span class="ictag">${t}</span>`).join('');
      document.getElementById('ic-date').textContent = h.date ? 'UPDATED: ' + h.date : 'UPDATED: LIVE';
      ic.className = 'show ' + (h.sev || 'elevated');

      // Smart positioning ‚Äî always stay inside canvas bounds
      let x = px + 16, y = py - 20;
      if (x + IW > W - 10) x = px - IW - 10;
      if (y + IH > H - 10) y = H - IH - 10;
      if (y < 50) y = 50;
      if (x < 10) x = 10;

      ic.style.left = x + 'px';
      ic.style.top = y + 'px';
      ic.style.display = 'block';
    }

    function showCardCenter(h) {
      const W = canvas.clientWidth || CW, H = canvas.clientHeight || CH;
      // Place on left side to avoid theater panel on right
      showCard(h, Math.max(130, W * 0.25), Math.max(80, H * 0.3));
    }

    canvas.addEventListener('wheel', e => {
      e.preventDefault();
      camera.position.z = Math.max(1.4, Math.min(5.0, camera.position.z + e.deltaY * 0.001));
    }, { passive: false });

    // ‚îÄ‚îÄ FIXED FLYTO ‚Äî correct rotation math for this globe coordinate system
    // Formula derivation: the point at (lat,lon) has position in 3D space:
    //   x = -sin(phi)*cos(theta)  where phi=(90-lat)*PI/180, theta=(lon+180)*PI/180
    //   y = cos(phi)
    //   z = sin(phi)*sin(theta)
    // To face the camera (+z), we need: targetRotY = -(90+lon)*PI/180, targetRotX = lat*PI/180
    function flyTo(lat, lon) {
      targetRotY = -(90 + lon) * Math.PI / 180;
      targetRotX = lat * Math.PI / 180 * 0.5; // partial tilt
      autoRotate = false;
      camera.position.z = 2.3;
    }

    function flyToTheater(lat, lon, label) {
      flyTo(lat, lon);
      const h = HOTSPOTS.find(h => Math.abs(h.lat - lat) < 3 && Math.abs(h.lon - lon) < 6);
      if (h) setTimeout(() => showCardCenter(h), 700);
    }
    window.flyTo = flyTo;
    window.flyToTheater = flyToTheater;

    function setFilter(f, btn) {
      activeFilter = f;
      document.querySelectorAll('.fbtn').forEach(b => b.classList.remove('on'));
      if (btn) btn.classList.add('on');
      renderMarkers();
    }
    window.setFilter = setFilter;

    function addCustomEvent() {
      const title = document.getElementById('ae-title').value;
      const lat = parseFloat(document.getElementById('ae-lat').value);
      const lon = parseFloat(document.getElementById('ae-lon').value);
      if (!title || isNaN(lat) || isNaN(lon)) return;
      customEvents.push({
        lat, lon, label: title, sev: document.getElementById('ae-sev').value,
        type: 'custom', title, body: document.getElementById('ae-desc').value,
        mkt: document.getElementById('ae-mkt').value, tags: ['CUSTOM']
      });
      document.getElementById('adddlg').classList.remove('show');
      renderMarkers();
    }
    window.addCustomEvent = addCustomEvent;

    // ‚îÄ‚îÄ ANIMATION ‚Äî optimized: reuse objects to avoid GC stutters
    let lastT = 0;
    const _quat = new THREE.Quaternion();
    const _euler = new THREE.Euler();
    const _rp = new THREE.Vector3();
    const _camDir = new THREE.Vector3();
    const _norm = new THREE.Vector3();

    function animate(t) {
      requestAnimationFrame(animate);
      const dt = Math.min((t - lastT) / 1000, 0.05); lastT = t;
      if (autoRotate) targetRotY += dt * 0.065;
      rotX += (targetRotX - rotX) * 0.08;
      rotY += (targetRotY - rotY) * 0.08;
      if (globeMesh) { globeMesh.rotation.x = rotX; globeMesh.rotation.y = rotY; }
      // clouds removed for performance

      _euler.set(rotX, rotY, 0, 'XYZ');
      _quat.setFromEuler(_euler);

      markers.forEach(({ mesh, ring, glow, basePos }) => {
        _rp.copy(basePos).applyQuaternion(_quat);
        mesh.position.copy(_rp); ring.position.copy(_rp); glow.position.copy(_rp);
        ring.lookAt(camera.position);
        ring.userData.phase = (ring.userData.phase || 0) + dt * 2.1;
        ring.material.opacity = 0.18 + 0.38 * Math.sin(ring.userData.phase);
        const s = 1 + 0.22 * Math.sin(ring.userData.phase);
        ring.scale.set(s, s, 1);
        glow.material.opacity = 0.03 + 0.1 * Math.abs(Math.sin(ring.userData.phase * .6));
        _camDir.copy(camera.position).sub(_rp).normalize();
        _norm.copy(_rp).normalize();
        const vis = _camDir.dot(_norm) > 0.06;
        mesh.visible = ring.visible = glow.visible = vis;
      });
      renderer.render(scene, camera);
    }
    animate(0);

    // Resize
    window.addEventListener('resize', () => {
      const w = canvas.clientWidth || window.innerWidth;
      const h = canvas.clientHeight || window.innerHeight;
      camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h);
    });

    // ‚îÄ‚îÄ LIVE GDELT NEWS FEED ‚Äî auto-refresh every 5 min
    async function fetchGDELTNews() {
      try {
        const r = await fetch('https://api.gdeltproject.org/api/v2/doc/doc?query=geopolitical%20conflict%20oil%20market%20sourcelang:english&mode=artlist&maxrecords=8&format=json&timespan=24h');
        const data = await r.json();
        const allArts = (data.articles || []).filter(a => {
          const t = a.title || '';
          return t.length > 20 && (t.charCodeAt(0) < 128);
        });
        // Deduplicate by title
        const seen = new Set();
        const arts = [];
        for (const a of allArts) {
          const key = (a.title || '').trim().toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          arts.push(a);
          if (arts.length >= 3) break;
        }
        const nf = document.getElementById('nf-items');
        if (arts.length > 0) {
          nf.innerHTML = arts.slice(0, 1).map(a => {
            const d = a.seendate ? a.seendate.substring(0, 4) + '-' + a.seendate.substring(4, 6) + '-' + a.seendate.substring(6, 8) : '';
            const dom = a.domain || 'GDELT';
            return `<div style="background:rgba(0,0,0,.85);border-left:3px solid #FF6600;padding:8px 12px;margin:3px 0">
              <a href="${a.url}" target="_blank" style="color:#DDD;text-decoration:none;font-size:14px;font-weight:600;line-height:1.4">${(a.title || '').substring(0, 100)}</a>
              <div style="color:#888;font-size:10px;margin-top:4px">${dom} ¬∑ ${d}</div>
            </div>`;
          }).join('');
        } else {
          nf.innerHTML = '<div style="color:#333;font-size:11px">Awaiting intel‚Ä¶</div>';
        }
      } catch (e) {
        document.getElementById('nf-items').innerHTML = '<div style="color:#333;font-size:11px">Feed offline</div>';
      }
    }
    fetchGDELTNews();
    setInterval(fetchGDELTNews, 300000); // refresh every 5 min
  </script>
</body>

</html>

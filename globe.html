<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SENTINEL GEO</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Courier New',monospace;}
body{background:#000;color:#d0d3d8;overflow:hidden;user-select:none;}
#c{display:block;width:100vw;height:100vh;}
#overlay{position:fixed;inset:0;pointer-events:none;z-index:10;}
#hdr{position:fixed;top:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,rgba(0,0,0,.95) 0%,transparent 100%);padding:7px 14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
#logo{color:#FF6600;font-size:13px;font-weight:700;letter-spacing:4px;}
#hst{font-size:9px;color:#444;display:flex;gap:12px;}
.hd{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;vertical-align:middle;}
.hg{background:#00CC44;box-shadow:0 0 4px #00CC44;animation:pb 2s infinite;}
.ha{background:#FF6600;box-shadow:0 0 4px #FF6600;}
.hr{background:#FF4444;box-shadow:0 0 4px #FF4444;animation:pb 1s infinite;}
@keyframes pb{0%,100%{opacity:1}50%{opacity:.25}}
#fb{position:fixed;left:10px;top:46px;z-index:20;display:flex;flex-direction:column;gap:3px;pointer-events:all;}
.fbtn{background:rgba(0,0,0,.88);border:1px solid #1a1a1a;color:#666;font-family:'Courier New',monospace;font-size:9px;letter-spacing:1px;padding:5px 10px;cursor:pointer;width:108px;text-align:left;transition:all .15s;}
.fbtn:hover,.fbtn.on{background:rgba(255,102,0,.1);border-color:#FF6600;color:#FF6600;}
/* ‚îÄ‚îÄ THEATER PANEL ‚Äî BIGGER TEXT ‚îÄ‚îÄ */
#tp{position:fixed;right:0;top:46px;width:220px;background:rgba(0,0,0,.95);border:1px solid #2a2a2a;border-right:none;z-index:20;box-shadow:-4px 0 20px rgba(255,102,0,.08);}
.tph{padding:8px 12px;font-size:11px;letter-spacing:2px;color:#FF6600;border-bottom:1px solid #2a2a2a;font-weight:700;text-transform:uppercase;}
.tpi{padding:10px 12px;border-bottom:1px solid #181818;cursor:pointer;transition:background .15s,border .1s;pointer-events:all;border-left:3px solid transparent;}
.tpi:hover{background:rgba(255,102,0,.1);border-left-color:#FF6600;}
.tpn{font-size:13px;color:#eee;font-weight:700;letter-spacing:.5px;}
.tps{font-size:12px;margin-top:3px;font-weight:700;letter-spacing:1px;}
.tc{color:#FF4444;text-shadow:0 0 8px rgba(255,68,68,.5);}
.te{color:#FF6600;text-shadow:0 0 8px rgba(255,102,0,.5);}
.tw{color:#FFCC00;text-shadow:0 0 8px rgba(255,204,0,.5);}
/* ‚îÄ‚îÄ INFO CARD ‚îÄ‚îÄ */
#ic{position:fixed;z-index:30;background:rgba(2,2,8,.97);border:1px solid #2a2a2a;border-left:4px solid #FF6600;padding:16px 18px;width:320px;display:none;pointer-events:all;box-shadow:0 8px 40px rgba(0,0,0,.85);}
#ic.show{display:block;}
#ic.critical{border-left-color:#FF4444;}
#ic.elevated{border-left-color:#FF6600;}
#ic.watch{border-left-color:#FFCC00;}
#ic-close{position:absolute;top:8px;right:10px;cursor:pointer;color:#555;font-size:16px;line-height:1;transition:color .15s;}
#ic-close:hover{color:#FF6600;}
.icl{font-size:9px;letter-spacing:2px;color:#555;margin-bottom:5px;text-transform:uppercase;}
.ict{font-size:15px;font-weight:700;color:#fff;margin-bottom:9px;line-height:1.3;}
.icb{font-size:11px;color:#999;line-height:1.8;margin-bottom:6px;}
.icm{color:#00AAFF;margin-top:9px;font-size:11px;font-weight:600;}
.ictags{margin-top:9px;display:flex;gap:4px;flex-wrap:wrap;}
.ictag{font-size:9px;padding:2px 7px;border:1px solid #2a2a2a;color:#555;letter-spacing:1px;}
#addbtn{position:fixed;right:230px;bottom:55px;z-index:20;background:rgba(255,102,0,.1);border:1px solid #FF6600;color:#FF6600;font-family:'Courier New',monospace;font-size:10px;padding:5px 12px;cursor:pointer;letter-spacing:1px;pointer-events:all;}
#addbtn:hover{background:rgba(255,102,0,.22);}
#adddlg{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0a0a0a;border:1px solid #FF6600;padding:20px;width:350px;z-index:50;display:none;pointer-events:all;}
#adddlg.show{display:block;}
#adddlg h3{color:#FF6600;font-size:11px;letter-spacing:2px;margin-bottom:14px;}
#adddlg label{font-size:9px;color:#888;display:block;margin-bottom:3px;letter-spacing:1px;}
#adddlg input,#adddlg select,#adddlg textarea{width:100%;background:#000;border:1px solid #1a1a1a;color:#ccc;font-family:'Courier New',monospace;font-size:10px;padding:5px 8px;margin-bottom:9px;}
.dbtns{display:flex;gap:8px;margin-top:4px;}
.dbok{flex:1;padding:6px;font-family:'Courier New',monospace;font-size:10px;cursor:pointer;border:1px solid #FF6600;background:rgba(255,102,0,.15);color:#FF6600;}
.dbcancel{flex:1;padding:6px;font-family:'Courier New',monospace;font-size:10px;cursor:pointer;border:1px solid #222;background:transparent;color:#666;}
#sb{position:fixed;bottom:0;left:0;right:0;padding:4px 14px;display:flex;justify-content:space-between;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,transparent 100%);z-index:20;font-size:8px;letter-spacing:1px;color:#333;pointer-events:none;}
#tt{position:fixed;z-index:25;background:rgba(0,0,0,.9);border:1px solid #FF6600;padding:4px 8px;font-size:9px;color:#FF8C00;display:none;pointer-events:none;white-space:nowrap;}
#loadscreen{position:fixed;inset:0;background:#000005;z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;}
#loadscreen.hidden{display:none;}
.ltxt{color:#FF6600;font-size:11px;letter-spacing:4px;animation:pb 1.5s infinite;}
.lbar{width:220px;height:2px;background:#111;position:relative;overflow:hidden;}
.lbar::after{content:'';position:absolute;left:-50%;width:50%;height:100%;background:linear-gradient(90deg,transparent,#FF6600,transparent);animation:slide 1.2s linear infinite;}
@keyframes slide{to{left:150%;}}
</style>
</head>
<body>
<div id="loadscreen">
  <div style="color:#FF6600;font-size:20px;font-weight:900;letter-spacing:5px">‚ö° SENTINEL GEO</div>
  <div class="ltxt">INITIALIZING GEOPOLITICAL INTELLIGENCE‚Ä¶</div>
  <div class="lbar"></div>
</div>
<canvas id="c"></canvas>
<div id="overlay"></div>

<div id="hdr">
  <div><span id="logo">‚ö° SENTINEL GEO</span><span style="color:#333;font-size:9px;margin-left:12px">GEOPOLITICAL INTELLIGENCE LAYER</span></div>
  <div id="hst">
    <span><span class="hd hg"></span>LIVE GLOBE</span>
    <span><span class="hd hg"></span>GDELT FEED</span>
    <span><span class="hd ha"></span>AIS LAYER</span>
    <span id="clk"></span>
  </div>
</div>

<div id="fb">
  <button class="fbtn on" onclick="setFilter('all',this)">‚óè ALL EVENTS</button>
  <button class="fbtn" onclick="setFilter('conflict',this)">‚óÜ CONFLICT</button>
  <button class="fbtn" onclick="setFilter('energy',this)">‚¨° ENERGY</button>
  <button class="fbtn" onclick="setFilter('shipping',this)">‚óà SHIPPING</button>
  <button class="fbtn" onclick="setFilter('minerals',this)">‚¨ü MINERALS</button>
  <button class="fbtn" onclick="setFilter('trade',this)">‚óá TRADE/TECH</button>
  <button class="fbtn" onclick="setFilter('custom',this)">+ MY EVENTS</button>
</div>

<div id="tp">
  <div class="tph">‚ö† THEATER STATUS</div>
  <div class="tpi" onclick="flyToTheater(31.5,34.8,'MIDDLE EAST')">
    <div class="tpn">MIDDLE EAST</div><div class="tps tc">‚óè CRITICAL</div>
  </div>
  <div class="tpi" onclick="flyToTheater(49,31,'UKRAINE')">
    <div class="tpn">UKRAINE</div><div class="tps tc">‚óè ACTIVE</div>
  </div>
  <div class="tpi" onclick="flyToTheater(14,43,'RED SEA')">
    <div class="tpn">RED SEA</div><div class="tps tc">‚óè DISRUPTED</div>
  </div>
  <div class="tpi" onclick="flyToTheater(26.5,56,'HORMUZ')">
    <div class="tpn">HORMUZ</div><div class="tps te">‚óè ELEVATED</div>
  </div>
  <div class="tpi" onclick="flyToTheater(14,2,'SAHEL')">
    <div class="tpn">SAHEL</div><div class="tps te">‚óè ELEVATED</div>
  </div>
  <div class="tpi" onclick="flyToTheater(25,121,'TAIWAN')">
    <div class="tpn">TAIWAN</div><div class="tps tw">‚óè MONITORING</div>
  </div>
  <div class="tpi" onclick="flyToTheater(12,115,'S. CHINA SEA')">
    <div class="tpn">S. CHINA SEA</div><div class="tps tw">‚óè MONITORING</div>
  </div>
</div>

<div id="ic">
  <span id="ic-close" onclick="document.getElementById('ic').style.display='none'">‚úï</span>
  <div class="icl" id="ic-sev"></div>
  <div class="ict" id="ic-ttl"></div>
  <div class="icb" id="ic-body"></div>
  <div class="icm" id="ic-mkt"></div>
  <div class="ictags" id="ic-tags"></div>
</div>
<div id="tt"></div>

<button id="addbtn" onclick="document.getElementById('adddlg').classList.add('show')">Ôºã ADD EVENT</button>
<div id="adddlg">
  <h3>ADD CUSTOM EVENT</h3>
  <label>TITLE</label><input id="ae-title" placeholder="e.g. Belarus Border Tensions">
  <label>LAT / LON</label>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
    <input id="ae-lat" placeholder="e.g. 52.0">
    <input id="ae-lon" placeholder="e.g. 28.0">
  </div>
  <label>DESCRIPTION</label><textarea id="ae-desc" rows="3" placeholder="Brief intel summary‚Ä¶"></textarea>
  <label>SEVERITY</label>
  <select id="ae-sev"><option value="critical">CRITICAL</option><option value="elevated">ELEVATED</option><option value="watch">WATCH</option></select>
  <label>MARKET IMPACT</label><input id="ae-mkt" placeholder="e.g. XLE, WTI Crude">
  <div class="dbtns">
    <button class="dbok" onclick="addCustomEvent()">CONFIRM</button>
    <button class="dbcancel" onclick="document.getElementById('adddlg').classList.remove('show')">CANCEL</button>
  </div>
</div>

<div id="sb">
  <div><span class="hd hr" style="display:inline-block"></span>3 CRITICAL &nbsp;&nbsp;<span class="hd ha" style="display:inline-block"></span>4 ELEVATED</div>
  <div>DRAG TO ROTATE ¬∑ SCROLL TO ZOOM ¬∑ CLICK MARKERS FOR INTEL</div>
  <div>SOURCES: THREE.JS ¬∑ GDELT ¬∑ AIS ¬∑ NASA BLUE MARBLE</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ‚îÄ‚îÄ CLOCK
setInterval(()=>{
  const d=new Date();
  document.getElementById('clk').textContent=d.toUTCString().slice(17,25)+' UTC';
},1000);

const W=window.innerWidth, H=window.innerHeight;
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
renderer.setSize(W,H);
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setClearColor(0x000005);

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(42,W/H,0.1,1000);
camera.position.set(0,0,2.7);

// ‚îÄ‚îÄ REALISTIC GLOBE SETUP
const loader=new THREE.TextureLoader();
const globeGeo=new THREE.SphereGeometry(1,96,96);
let globeMesh=null, cloudMesh=null;
let earthTex=null, specTex=null, cloudTex=null;

function buildFallbackTexture(){
  // Procedural detailed Earth texture
  const cv=document.createElement('canvas'); cv.width=2048; cv.height=1024;
  const ctx=cv.getContext('2d');
  // Deep ocean
  const og=ctx.createLinearGradient(0,0,2048,1024);
  og.addColorStop(0,'#030c1c'); og.addColorStop(.5,'#061625'); og.addColorStop(1,'#030c1c');
  ctx.fillStyle=og; ctx.fillRect(0,0,2048,1024);
  // Ocean depth variation
  ctx.fillStyle='rgba(0,20,50,0.3)';
  for(let i=0;i<20;i++){
    ctx.beginPath();
    ctx.ellipse(Math.random()*2048,Math.random()*1024,Math.random()*200+50,Math.random()*100+30,Math.random()*Math.PI,0,Math.PI*2);
    ctx.fill();
  }
  // Continents
  ctx.fillStyle='#1d3c18';
  const continents=[
    // North America
    [310,220,175,130,-.2],[260,310,100,90,.1],[230,350,65,55,0],[380,290,85,65,-.1],
    // South America
    [330,490,95,75,.1],[305,560,80,95,-.05],[315,630,65,72,-.1],
    // Europe
    [620,205,90,65,.05],[665,235,65,52,-.1],[638,188,55,42,.15],
    // Africa
    [625,345,105,95,.05],[615,430,95,105,-.05],[605,510,75,85,0],[598,585,55,52,.1],
    // Asia mainland
    [715,195,140,105,.1],[820,215,125,92,-.05],[875,255,105,80,.05],[920,295,90,72,-.1],
    [962,195,85,62,.1],[1010,280,75,62,-.1],[840,175,62,52,.2],
    // Japan
    [980,230,18,45,.2],[990,260,12,30,.2],
    // SE Asia
    [920,380,70,55,.05],[960,420,55,42,-.1],
    // Australia
    [905,510,95,62,.05],[925,565,72,52,-.1],
    // Greenland
    [358,138,68,45,.1],[328,128,42,32,.15],
    // UK/Ireland
    [598,195,20,28,.1],[612,192,14,22,.1],
  ];
  continents.forEach(([x,y,w,h,r])=>{
    ctx.save(); ctx.translate(x,y); ctx.rotate(r);
    ctx.beginPath(); ctx.ellipse(0,0,w,h,0,0,Math.PI*2); ctx.fill(); ctx.restore();
  });
  // Highland texture on continents
  ctx.fillStyle='#162d12';
  [[720,215,28,18],[690,228,22,14],[882,225,18,12]].forEach(([x,y,w,h])=>{
    ctx.beginPath();ctx.ellipse(x,y,w,h,0,0,Math.PI*2);ctx.fill();
  });
  // Desert/savanna tones
  ctx.fillStyle='rgba(80,60,20,0.25)';
  [[620,380,80,50],[900,310,60,40]].forEach(([x,y,w,h])=>{
    ctx.beginPath();ctx.ellipse(x,y,w,h,0,0,Math.PI*2);ctx.fill();
  });
  // Arctic ice
  ctx.fillStyle='#c5dde8';
  ctx.fillRect(0,0,2048,22);
  ctx.fillRect(0,996,2048,28);
  // Antarctic shelf
  ctx.fillStyle='rgba(180,210,230,0.7)';
  ctx.fillRect(0,22,2048,18);
  ctx.fillRect(0,978,2048,18);
  return new THREE.CanvasTexture(cv);
}

function applyGlobe(){
  const mat=new THREE.MeshPhongMaterial({
    map: earthTex || buildFallbackTexture(),
    specularMap: specTex || null,
    specular: specTex ? new THREE.Color(0x335599) : new THREE.Color(0x112244),
    shininess: specTex ? 55 : 10,
    emissive: new THREE.Color(0x000810),
    emissiveIntensity: 0.2,
  });
  if(globeMesh){ scene.remove(globeMesh); }
  globeMesh=new THREE.Mesh(globeGeo,mat);
  scene.add(globeMesh);
  if(cloudTex && !cloudMesh){
    const cm=new THREE.MeshPhongMaterial({
      map:cloudTex, transparent:true, opacity:0.32,
      depthWrite:false, blending:THREE.AdditiveBlending,
    });
    cloudMesh=new THREE.Mesh(new THREE.SphereGeometry(1.007,64,64),cm);
    scene.add(cloudMesh);
  }
  document.getElementById('loadscreen').classList.add('hidden');
}

// Load earth texture ‚Äî multiple fallbacks
const EARTH=[
  'https://raw.githubusercontent.com/turban/webgl-earth/master/images/2_no_clouds_4k.jpg',
  'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
];
const SPEC=['https://raw.githubusercontent.com/turban/webgl-earth/master/images/8081_earthspec10k.jpg'];
const CLOUDS=['https://raw.githubusercontent.com/turban/webgl-earth/master/images/fair_clouds_4k.png'];

let earthReady=false;
function tryEarth(i){
  if(i>=EARTH.length){applyGlobe();return;}
  loader.load(EARTH[i],t=>{earthTex=t;earthReady=true;applyGlobe();},undefined,()=>tryEarth(i+1));
}
tryEarth(0);
loader.load(SPEC[0],t=>{specTex=t;if(earthReady)applyGlobe();},undefined,()=>{});
loader.load(CLOUDS[0],t=>{cloudTex=t;if(earthReady)applyGlobe();},undefined,()=>{});
setTimeout(()=>{document.getElementById('loadscreen').classList.add('hidden');},5000);

// ‚îÄ‚îÄ ATMOSPHERE
const atm1=new THREE.MeshPhongMaterial({color:0x003366,transparent:true,opacity:0.16,side:THREE.FrontSide,depthWrite:false,blending:THREE.AdditiveBlending});
scene.add(new THREE.Mesh(new THREE.SphereGeometry(1.018,64,64),atm1));
const atm2=new THREE.MeshPhongMaterial({color:0x001133,transparent:true,opacity:0.07,side:THREE.FrontSide,depthWrite:false,blending:THREE.AdditiveBlending});
scene.add(new THREE.Mesh(new THREE.SphereGeometry(1.042,64,64),atm2));
// Grid overlay
scene.add(new THREE.Mesh(new THREE.SphereGeometry(1.001,24,12),new THREE.MeshBasicMaterial({color:0x001a33,wireframe:true,transparent:true,opacity:0.04})));

// ‚îÄ‚îÄ LIGHTING
scene.add(new THREE.AmbientLight(0x112233,0.75));
const sun=new THREE.DirectionalLight(0xfff5ee,1.7); sun.position.set(6,3,4); scene.add(sun);
const fill=new THREE.DirectionalLight(0x0a1533,0.28); fill.position.set(-6,-2,-4); scene.add(fill);
const rim=new THREE.DirectionalLight(0x113355,0.45); rim.position.set(-3,1,-5); scene.add(rim);

// ‚îÄ‚îÄ STARS (colorized)
const sg=new THREE.BufferGeometry();
const sp=[],sc=[];
for(let i=0;i<4000;i++){
  const th=Math.random()*Math.PI*2, ph=Math.acos(2*Math.random()-1), r=65+Math.random()*90;
  sp.push(r*Math.sin(ph)*Math.cos(th),r*Math.cos(ph),r*Math.sin(ph)*Math.sin(th));
  const t=Math.random();
  if(t<.1)sc.push(.75,.75,1.0);
  else if(t<.2)sc.push(1.0,.9,.65);
  else sc.push(.45,.5,.62);
}
sg.setAttribute('position',new THREE.Float32BufferAttribute(sp,3));
sg.setAttribute('color',new THREE.Float32BufferAttribute(sc,3));
scene.add(new THREE.Points(sg,new THREE.PointsMaterial({size:.12,vertexColors:true})));

// ‚îÄ‚îÄ HOTSPOT DATA
const HOTSPOTS=[
  {lat:31.5,lon:34.8,label:'GAZA/ISRAEL',sev:'critical',type:'conflict',
   title:'Gaza ‚Äî Active Conflict Zone',
   body:'Ongoing operations in Gaza. Regional escalation risk via Hezbollah and IRGC proxies. Iran-backed network active across Lebanon, Syria, Iraq. US carrier strike group in Eastern Med.',
   mkt:'WTI (CL=F), Gold (GLD), XLE, ITA, LMT',tags:['OIL RISK','ESCALATION','IRGC']},
  {lat:14,lon:43,label:'RED SEA',sev:'critical',type:'shipping',
   title:'Red Sea ‚Äî Houthi Shipping Attacks',
   body:'Houthi ballistic and drone attacks on commercial vessels ongoing. Ships rerouting around Cape of Good Hope adding 12‚Äì14 days voyage time. Container rates +35% vs pre-crisis. Suez Canal transits down ~40%.',
   mkt:'Container ETFs, FDX, UPS, European CPI, XLE',tags:['SHIPPING','INFLATION','HOUTHI']},
  {lat:26.5,lon:56,label:'HORMUZ',sev:'elevated',type:'energy',
   title:'Strait of Hormuz ‚Äî Iranian Naval Presence',
   body:"IRGC elevated naval presence in Persian Gulf. 20% of global oil transits Hormuz daily. Lloyd's war risk premium elevated +300%. Tanker insurance spiking.",
   mkt:'WTI (CL=F), Brent, XLE, airline margins',tags:['20% GLOBAL OIL','IRAN','LLOYD\'S']},
  {lat:25,lon:121,label:'TAIWAN',sev:'elevated',type:'trade',
   title:'Taiwan Strait ‚Äî PLA Military Posture',
   body:'PLA conducting regular exercises near median line. TSMC produces 90%+ of advanced chips <5nm. US carrier groups in Western Pacific. AUKUS submarine deliveries accelerating.',
   mkt:'SMH, NVDA, AAPL supply chain, SOXX, TSM',tags:['TSMC','SEMICONDUCTORS','PLA']},
  {lat:49,lon:31,label:'UKRAINE',sev:'critical',type:'conflict',
   title:'Ukraine ‚Äî Active War Theater',
   body:'Frontline active across 1,000km. Russia targeting power grid and energy infrastructure ahead of winter. NATO posture elevated ‚Äî Patriot deployments expanding. Grain corridor disrupted.',
   mkt:'NG=F (natgas), ZW=F (wheat), European banks, defense ETFs',tags:['NATGAS','GRAIN','NATO']},
  {lat:14,lon:2,label:'SAHEL',sev:'elevated',type:'minerals',
   title:'Sahel ‚Äî Coups & Critical Minerals',
   body:'Coup governments across Mali, Niger, Burkina Faso. French forces fully withdrawn. Wagner/Africa Corps active. Chinese mining rights expanding in cobalt, gold, lithium zones.',
   mkt:'GDX, SIL, LIT, gold futures',tags:['GOLD','LITHIUM','WAGNER']},
  {lat:-5,lon:23.5,label:'DRC/COBALT',sev:'elevated',type:'minerals',
   title:'DRC ‚Äî Cobalt Supply Chain',
   body:'DRC produces ~70% of world cobalt. M23 rebels active near Goma. Eastern DRC conflict threatening mining operations. Chinese firms control ~80% of processing capacity.',
   mkt:'Cobalt, TSLA supply chain, ALB, SQM, LIT',tags:['70% COBALT','EV','M23']},
  {lat:12,lon:115,label:'S CHINA SEA',sev:'elevated',type:'shipping',
   title:'South China Sea ‚Äî Territorial Disputes',
   body:'$3T+ annual trade transits here. Philippines-China confrontations at Second Thomas Shoal escalating. Water cannon incidents. ASEAN unity fractured. US-Phil. military exercises intensifying.',
   mkt:'Container shipping, Asian FX, semiconductors',tags:['$3T TRADE','NAVAL','PHILIPPINES']},
  {lat:56,lon:37.6,label:'RUSSIA',sev:'elevated',type:'energy',
   title:'Russia ‚Äî Energy Export Rerouting',
   body:'Russian oil rerouted to China and India at 15‚Äì20% discount. European LNG costs remain elevated. Sanctions enforcement tightening. Shadow fleet growing.',
   mkt:'European natgas, LNG stocks, UNG, XLE',tags:['LNG','SANCTIONS','OPEC+']},
  {lat:35.6,lon:139.7,label:'BOJ/YEN',sev:'watch',type:'trade',
   title:'Japan ‚Äî BOJ Policy & Yen Carry Trade',
   body:'BOJ normalizing ultra-loose policy after 3 decades. Yen carry trade unwind risk ‚Äî estimated $4T+ in positions. Rate hike trajectory uncertain ‚Äî global volatility trigger.',
   mkt:'USD/JPY, Nikkei, DXY, global bonds, TLT',tags:['YEN CARRY','BOJ','REFLATION']},
  {lat:-20,lon:28,label:'ZIMBABWE',sev:'watch',type:'minerals',
   title:'Zimbabwe ‚Äî Lithium Export Controls',
   body:'Zimbabwe banned raw lithium ore exports in 2023. Chinese firms dominate local processing. EV battery supply chain implications for Tesla, BYD.',
   mkt:'LIT, ALB (Albemarle), SQM, LTHM',tags:['LITHIUM','EV','EXPORT BAN']},
  {lat:33,lon:44,label:'IRAQ/IRAN',sev:'elevated',type:'energy',
   title:'Iraq ‚Äî Iranian Proxy Network',
   body:'Iranian-backed militias (Islamic Resistance in Iraq) targeted 160+ US facilities. Iraqi oil output near record high at 4.3Mbpd. OPEC+ compliance politics complex.',
   mkt:'WTI, Brent, XLE, OIH',tags:['IRAN PROXIES','OPEC+','OIL']},
];

const COLORS={critical:'#FF4444',elevated:'#FF6600',watch:'#FFCC00'};
let customEvents=[],activeFilter='all';
let autoRotate=true,dragging=false,isDrag=false,dragDist=0;
let prevX=0,prevY=0,rotX=0,rotY=0,targetRotX=0,targetRotY=0;
const markers=[];

function latLonToVec3(lat,lon,r=1.013){
  const phi=(90-lat)*Math.PI/180;
  const theta=(lon+180)*Math.PI/180;
  return new THREE.Vector3(
    -r*Math.sin(phi)*Math.cos(theta),
    r*Math.cos(phi),
    r*Math.sin(phi)*Math.sin(theta)
  );
}

function makeMarker(h){
  const col=COLORS[h.sev]||'#FF6600';
  const c=new THREE.Color(col);
  const pos=latLonToVec3(h.lat,h.lon);

  // Core dot
  const mesh=new THREE.Mesh(
    new THREE.SphereGeometry(0.022,16,16),
    new THREE.MeshBasicMaterial({color:c})
  );
  mesh.position.copy(pos); mesh.userData={hotspot:h};

  // Glow halo
  const glow=new THREE.Mesh(
    new THREE.SphereGeometry(0.040,16,16),
    new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:0.12,side:THREE.FrontSide})
  );
  glow.position.copy(pos); glow.userData={hotspot:h};

  // Pulse ring
  const ring=new THREE.Mesh(
    new THREE.RingGeometry(0.028,0.037,32),
    new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:0.55,side:THREE.DoubleSide})
  );
  ring.position.copy(pos); ring.lookAt(0,0,0); ring.rotateX(Math.PI/2);
  ring.userData={phase:Math.random()*Math.PI*2};

  scene.add(ring); scene.add(glow); scene.add(mesh);
  markers.push({mesh,ring,glow,hotspot:h,basePos:pos.clone()});
}

function renderMarkers(){
  markers.forEach(({mesh,ring,glow})=>{scene.remove(mesh);scene.remove(ring);scene.remove(glow);});
  markers.length=0;
  HOTSPOTS.filter(h=>activeFilter==='all'||h.type===activeFilter).forEach(makeMarker);
  if(activeFilter==='custom'||activeFilter==='all') customEvents.forEach(makeMarker);
}
renderMarkers();

// ‚îÄ‚îÄ INTERACTION
const canvas=document.getElementById('c');
const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();

function mpos(e){const r=canvas.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top};}

canvas.addEventListener('mousedown',e=>{
  dragging=true; isDrag=false; dragDist=0; autoRotate=false;
  const p=mpos(e); prevX=p.x; prevY=p.y;
});
canvas.addEventListener('mouseup',()=>{dragging=false;});
canvas.addEventListener('mousemove',e=>{
  const p=mpos(e);
  if(dragging){
    const dx=p.x-prevX,dy=p.y-prevY;
    dragDist+=Math.abs(dx)+Math.abs(dy);
    if(dragDist>5) isDrag=true;
    targetRotY+=dx*0.005; targetRotX+=dy*0.004;
    targetRotX=Math.max(-Math.PI/2.1,Math.min(Math.PI/2.1,targetRotX));
    prevX=p.x; prevY=p.y;
  }
  mouse.x=(p.x/W)*2-1; mouse.y=-(p.y/H)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const all=markers.flatMap(m=>[m.mesh,m.glow]);
  const hits=raycaster.intersectObjects(all);
  const tt=document.getElementById('tt');
  if(hits.length){
    const h=hits[0].object.userData.hotspot;
    tt.style.display='block';
    tt.style.left=(e.clientX+12)+'px'; tt.style.top=(e.clientY-8)+'px';
    tt.textContent=h.label+' ‚Äî '+h.sev.toUpperCase();
    canvas.style.cursor='pointer';
  }else{
    tt.style.display='none'; canvas.style.cursor='default';
  }
});
canvas.addEventListener('click',e=>{
  if(isDrag) return;
  mouse.x=(e.clientX/W)*2-1; mouse.y=-(e.clientY/H)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const all=markers.flatMap(m=>[m.mesh,m.glow]);
  const hits=raycaster.intersectObjects(all);
  if(hits.length){
    showCard(hits[0].object.userData.hotspot,e.clientX,e.clientY);
  }else{
    document.getElementById('ic').style.display='none';
  }
});

function showCard(h,cx,cy){
  const ic=document.getElementById('ic');
  document.getElementById('ic-sev').textContent=h.sev.toUpperCase()+' ‚Äî '+h.type.toUpperCase();
  document.getElementById('ic-ttl').textContent=h.title||h.label;
  document.getElementById('ic-body').textContent=h.body||'';
  document.getElementById('ic-mkt').textContent=h.mkt?'üìä MARKET: '+h.mkt:'';
  document.getElementById('ic-tags').innerHTML=(h.tags||[]).map(t=>`<span class="ictag">${t}</span>`).join('');
  ic.className='show '+(h.sev||'elevated');
  let x=cx+18,y=cy-20;
  if(x+330>W) x=cx-338; if(y+280>H) y=H-285; if(y<50) y=50;
  ic.style.left=x+'px'; ic.style.top=y+'px'; ic.style.display='block';
}

function showCardCenter(h){
  // Center popup for theater panel clicks
  const x=Math.max(130,W/2-160);
  const y=Math.max(60,H/2-140);
  showCard(h,x,y);
}

canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  camera.position.z=Math.max(1.4,Math.min(5.0,camera.position.z+e.deltaY*0.001));
},{passive:false});

// ‚îÄ‚îÄ THEATER FLY-TO (FIXED: rotates globe correctly and opens popup)
function flyTo(lat,lon){
  // Convert lat/lon to target globe rotation
  // Globe rotation Y corresponds to -longitude (globe rotates opposite to lon)
  targetRotY = -lon * Math.PI/180;
  targetRotX = -lat * Math.PI/180 * 0.5;
  autoRotate=false;
  camera.position.z=2.25;
}

function flyToTheater(lat,lon,label){
  flyTo(lat,lon);
  const h=HOTSPOTS.find(h=>Math.abs(h.lat-lat)<3&&Math.abs(h.lon-lon)<6);
  if(h) setTimeout(()=>showCardCenter(h),700);
}
window.flyTo=flyTo;
window.flyToTheater=flyToTheater;

function setFilter(f,btn){
  activeFilter=f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  renderMarkers();
}
window.setFilter=setFilter;

function addCustomEvent(){
  const title=document.getElementById('ae-title').value;
  const lat=parseFloat(document.getElementById('ae-lat').value);
  const lon=parseFloat(document.getElementById('ae-lon').value);
  if(!title||isNaN(lat)||isNaN(lon)) return;
  customEvents.push({lat,lon,label:title,sev:document.getElementById('ae-sev').value,type:'custom',
    title,body:document.getElementById('ae-desc').value,mkt:document.getElementById('ae-mkt').value,tags:['CUSTOM']});
  document.getElementById('adddlg').classList.remove('show');
  renderMarkers();
}
window.addCustomEvent=addCustomEvent;

// ‚îÄ‚îÄ ANIMATION
let lastT=0;
function animate(t){
  requestAnimationFrame(animate);
  const dt=Math.min((t-lastT)/1000,0.05); lastT=t;
  if(autoRotate) targetRotY+=dt*0.07;
  rotX+=(targetRotX-rotX)*0.06;
  rotY+=(targetRotY-rotY)*0.06;
  if(globeMesh){globeMesh.rotation.x=rotX;globeMesh.rotation.y=rotY;}
  if(cloudMesh){cloudMesh.rotation.x=rotX;cloudMesh.rotation.y=rotY+t*0.00004;}
  markers.forEach(({mesh,ring,glow,basePos})=>{
    const quat=new THREE.Quaternion().setFromEuler(new THREE.Euler(rotX,rotY,0,'XYZ'));
    const rp=basePos.clone().applyQuaternion(quat);
    mesh.position.copy(rp); ring.position.copy(rp); glow.position.copy(rp);
    ring.lookAt(camera.position);
    ring.userData.phase=(ring.userData.phase||0)+dt*2.2;
    ring.material.opacity=0.2+0.35*Math.sin(ring.userData.phase);
    const s=1+0.2*Math.sin(ring.userData.phase);
    ring.scale.set(s,s,1);
    glow.material.opacity=0.04+0.12*Math.abs(Math.sin(ring.userData.phase*.7));
    const vis=camera.position.clone().sub(rp).normalize().dot(rp.clone().normalize())>0.08;
    mesh.visible=ring.visible=glow.visible=vis;
  });
  renderer.render(scene,camera);
}
animate(0);

window.addEventListener('resize',()=>{
  const w=window.innerWidth,h=window.innerHeight;
  camera.aspect=w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h);
});
</script>
</body>
</html>

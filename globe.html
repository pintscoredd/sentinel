<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SENTINEL GEO</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Courier New',monospace;}
body{background:#000;color:#d0d3d8;overflow:hidden;user-select:none;}
#c{display:block;width:100vw;height:100vh;}
#overlay{position:fixed;inset:0;pointer-events:none;z-index:10;}
/* Header */
#hdr{position:fixed;top:0;left:0;right:0;z-index:20;background:linear-gradient(180deg,rgba(0,0,0,0.95) 0%,transparent 100%);padding:7px 14px;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
#logo{color:#FF6600;font-size:13px;font-weight:700;letter-spacing:4px;}
#hst{font-size:9px;color:#444;display:flex;gap:12px;}
.hd{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;vertical-align:middle;}
.hg{background:#00CC44;box-shadow:0 0 4px #00CC44;animation:pb 2s infinite;}
.ha{background:#FF6600;box-shadow:0 0 4px #FF6600;}
.hr{background:#FF4444;box-shadow:0 0 4px #FF4444;animation:pb 1s infinite;}
@keyframes pb{0%,100%{opacity:1}50%{opacity:.25}}
/* Filter bar */
#fb{position:fixed;left:10px;top:46px;z-index:20;display:flex;flex-direction:column;gap:3px;pointer-events:all;}
.fbtn{background:rgba(0,0,0,.88);border:1px solid #1a1a1a;color:#666;font-family:'Courier New',monospace;font-size:9px;letter-spacing:1px;padding:5px 10px;cursor:pointer;width:108px;text-align:left;transition:all .15s;}
.fbtn:hover,.fbtn.on{background:rgba(255,102,0,.1);border-color:#FF6600;color:#FF6600;}
/* Theater panel */
#tp{position:fixed;right:0;top:46px;width:190px;background:rgba(0,0,0,.92);border:1px solid #1a1a1a;border-right:none;z-index:20;}
.tph{padding:5px 10px;font-size:9px;letter-spacing:2px;color:#FF6600;border-bottom:1px solid #1a1a1a;}
.tpi{padding:6px 10px;border-bottom:1px solid #111;cursor:pointer;transition:background .15s;pointer-events:all;}
.tpi:hover{background:rgba(255,102,0,.07);}
.tpn{font-size:10px;color:#ccc;font-weight:600;}
.tps{font-size:9px;margin-top:2px;}
.tc{color:#FF4444;}.te{color:#FF6600;}.tw{color:#FFCC00;}
/* Info card */
#ic{position:fixed;z-index:30;background:rgba(0,0,0,.97);border:1px solid #1a1a1a;border-left:3px solid #FF6600;padding:13px 15px;width:300px;display:none;pointer-events:none;}
#ic.show{display:block;}
#ic.critical{border-left-color:#FF4444;}
#ic.elevated{border-left-color:#FF6600;}
#ic.watch{border-left-color:#FFCC00;}
.icl{font-size:8px;letter-spacing:2px;color:#444;margin-bottom:3px;}
.ict{font-size:12px;font-weight:700;color:#fff;margin-bottom:5px;}
.icb{font-size:10px;color:#888;line-height:1.65;}
.icm{color:#00AAFF;margin-top:6px;font-size:10px;}
.ictags{margin-top:7px;display:flex;gap:4px;flex-wrap:wrap;}
.ictag{font-size:8px;padding:2px 5px;border:1px solid #222;color:#444;}
/* Add event */
#addbtn{position:fixed;right:200px;bottom:55px;z-index:20;background:rgba(255,102,0,.1);border:1px solid #FF6600;color:#FF6600;font-family:'Courier New',monospace;font-size:10px;padding:5px 12px;cursor:pointer;letter-spacing:1px;pointer-events:all;}
#addbtn:hover{background:rgba(255,102,0,.22);}
#adddlg{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0a0a0a;border:1px solid #FF6600;padding:20px;width:350px;z-index:50;display:none;pointer-events:all;}
#adddlg.show{display:block;}
#adddlg h3{color:#FF6600;font-size:11px;letter-spacing:2px;margin-bottom:14px;}
#adddlg label{font-size:9px;color:#888;display:block;margin-bottom:3px;letter-spacing:1px;}
#adddlg input,#adddlg select,#adddlg textarea{width:100%;background:#000;border:1px solid #1a1a1a;color:#ccc;font-family:'Courier New',monospace;font-size:10px;padding:5px 8px;margin-bottom:9px;}
.dbtns{display:flex;gap:8px;margin-top:4px;}
.dbok{flex:1;padding:6px;font-family:'Courier New',monospace;font-size:10px;cursor:pointer;border:1px solid #FF6600;background:rgba(255,102,0,.15);color:#FF6600;}
.dbcancel{flex:1;padding:6px;font-family:'Courier New',monospace;font-size:10px;cursor:pointer;border:1px solid #222;background:transparent;color:#666;}
/* Status bar */
#sb{position:fixed;bottom:0;left:0;right:0;padding:4px 14px;display:flex;justify-content:space-between;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,transparent 100%);z-index:20;font-size:8px;letter-spacing:1px;color:#333;pointer-events:none;}
/* Tooltip */
#tt{position:fixed;z-index:25;background:rgba(0,0,0,.9);border:1px solid #FF6600;padding:4px 8px;font-size:9px;color:#FF8C00;display:none;pointer-events:none;white-space:nowrap;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="overlay"></div>

<div id="hdr">
  <div><span id="logo">‚ö° SENTINEL GEO</span><span style="color:#333;font-size:9px;margin-left:12px">GEOPOLITICAL INTELLIGENCE LAYER</span></div>
  <div id="hst">
    <span><span class="hd hg"></span>THREE.JS GLOBE</span>
    <span><span class="hd hg"></span>GDELT LIVE</span>
    <span><span class="hd ha"></span>AIS FEED</span>
    <span id="clk"></span>
  </div>
</div>

<div id="fb">
  <button class="fbtn on" onclick="setFilter('all',this)">‚óè ALL EVENTS</button>
  <button class="fbtn" onclick="setFilter('conflict',this)">‚óÜ CONFLICT</button>
  <button class="fbtn" onclick="setFilter('energy',this)">‚¨° ENERGY</button>
  <button class="fbtn" onclick="setFilter('shipping',this)">‚óà SHIPPING</button>
  <button class="fbtn" onclick="setFilter('minerals',this)">‚¨ü MINERALS</button>
  <button class="fbtn" onclick="setFilter('trade',this)">‚óá TRADE/TECH</button>
  <button class="fbtn" onclick="setFilter('custom',this)">+ MY EVENTS</button>
</div>

<div id="tp">
  <div class="tph">THEATER STATUS</div>
  <div class="tpi" onclick="flyTo(31.5,34.8)"><div class="tpn">MIDDLE EAST</div><div class="tps tc">CRITICAL</div></div>
  <div class="tpi" onclick="flyTo(49,31)"><div class="tpn">UKRAINE</div><div class="tps tc">ACTIVE</div></div>
  <div class="tpi" onclick="flyTo(14,43)"><div class="tpn">RED SEA</div><div class="tps tc">DISRUPTED</div></div>
  <div class="tpi" onclick="flyTo(26.5,56)"><div class="tpn">HORMUZ</div><div class="tps te">ELEVATED</div></div>
  <div class="tpi" onclick="flyTo(14,2)"><div class="tpn">SAHEL</div><div class="tps te">ELEVATED</div></div>
  <div class="tpi" onclick="flyTo(25,121)"><div class="tpn">TAIWAN</div><div class="tps tw">MONITORING</div></div>
  <div class="tpi" onclick="flyTo(12,115)"><div class="tpn">S. CHINA SEA</div><div class="tps tw">MONITORING</div></div>
</div>

<div id="ic"><div class="icl" id="ic-sev"></div><div class="ict" id="ic-ttl"></div><div class="icb" id="ic-body"></div><div class="icm" id="ic-mkt"></div><div class="ictags" id="ic-tags"></div></div>
<div id="tt"></div>

<button id="addbtn" onclick="document.getElementById('adddlg').classList.add('show')">Ôºã ADD EVENT</button>
<div id="adddlg">
  <h3>ADD CUSTOM EVENT</h3>
  <label>TITLE</label><input id="ae-title" placeholder="e.g. Belarus Border Tensions">
  <label>LAT / LON</label>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px"><input id="ae-lat" placeholder="e.g. 52.0"><input id="ae-lon" placeholder="e.g. 28.0"></div>
  <label>DESCRIPTION</label><textarea id="ae-desc" placeholder="Brief intel summary‚Ä¶"></textarea>
  <label>SEVERITY</label>
  <select id="ae-sev"><option value="critical">CRITICAL</option><option value="elevated">ELEVATED</option><option value="watch">WATCH</option></select>
  <label>MARKET IMPACT</label><input id="ae-mkt" placeholder="e.g. XLE, WTI Crude">
  <div class="dbtns">
    <button class="dbok" onclick="addCustomEvent()">CONFIRM</button>
    <button class="dbcancel" onclick="document.getElementById('adddlg').classList.remove('show')">CANCEL</button>
  </div>
</div>

<div id="sb">
  <div><span class="hd hr" style="display:inline-block"></span>3 CRITICAL &nbsp;&nbsp;<span class="hd ha" style="display:inline-block"></span>4 ELEVATED</div>
  <div>DRAG TO ROTATE ¬∑ SCROLL TO ZOOM ¬∑ CLICK MARKERS FOR INTEL</div>
  <div>SOURCES: THREE.JS ¬∑ GDELT ¬∑ AIS ¬∑ NASA BLUE MARBLE</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(()=>{
  const d=new Date();
  document.getElementById('clk').textContent=d.toUTCString().slice(17,25)+' UTC';
},1000);

// ‚îÄ‚îÄ SCENE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const W=window.innerWidth, H=window.innerHeight;
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
renderer.setSize(W,H); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setClearColor(0x000000);

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,W/H,0.1,1000);
camera.position.set(0,0,2.8);

// ‚îÄ‚îÄ GLOBE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const loader=new THREE.TextureLoader();
// Use a simple procedural earth appearance since external textures may be blocked
const globeGeo=new THREE.SphereGeometry(1,64,64);

// Load earth texture - use multiple fallbacks
const TEXTURES=[
  'https://raw.githubusercontent.com/turban/webgl-earth/master/images/2_no_clouds_4k.jpg',
  'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
];

let globeMesh;
function createGlobe(texture){
  const mat=new THREE.MeshPhongMaterial({
    map: texture||null,
    color: texture?0xffffff:0x1a3a5c,
    emissive: 0x000308,
    specular: 0x222244,
    shininess: 8,
  });
  if(!texture){
    // Draw continents procedurally via canvas
    const cv=document.createElement('canvas'); cv.width=1024; cv.height=512;
    const ctx=cv.getContext('2d');
    // Ocean
    ctx.fillStyle='#0a1628'; ctx.fillRect(0,0,1024,512);
    // Simple continent blobs
    ctx.fillStyle='#1a3a1a';
    const continents=[
      [200,150,120,80],[350,180,80,60],[420,200,40,30],
      [430,140,60,50],[500,180,30,25],[530,200,20,15],
      [80,170,90,70],[100,240,60,50],[90,300,40,35],
      [530,100,80,60],[580,130,50,40],[620,160,30,25],
      [700,200,50,40],[720,250,40,30],
      [200,300,60,50],[170,350,50,40],
      [300,380,40,30],[320,350,30,25],
      [120,120,30,20],[140,100,25,15],
    ];
    continents.forEach(([x,y,w,h])=>{
      ctx.beginPath();ctx.ellipse(x,y,w,h,0,0,Math.PI*2);ctx.fill();
    });
    // Ice caps
    ctx.fillStyle='#3a5a6a';
    ctx.fillRect(0,0,1024,30); ctx.fillRect(0,480,1024,32);
    const t=new THREE.CanvasTexture(cv);
    mat.map=t; mat.needsUpdate=true;
  }
  globeMesh=new THREE.Mesh(globeGeo,mat);
  scene.add(globeMesh);
}

// Try loading real texture
loader.load(TEXTURES[0], t=>createGlobe(t), undefined, ()=>{
  loader.load(TEXTURES[1], t=>createGlobe(t), undefined, ()=>createGlobe(null));
});

// Atmosphere glow
const atmGeo=new THREE.SphereGeometry(1.015,64,64);
const atmMat=new THREE.MeshPhongMaterial({
  color:0x002244,transparent:true,opacity:0.12,side:THREE.FrontSide,depthWrite:false
});
scene.add(new THREE.Mesh(atmGeo,atmMat));

// Wireframe overlay (subtle grid)
const wfGeo=new THREE.SphereGeometry(1.001,32,16);
const wfMat=new THREE.MeshBasicMaterial({color:0x001122,wireframe:true,transparent:true,opacity:0.06});
scene.add(new THREE.Mesh(wfGeo,wfMat));

// Lighting
scene.add(new THREE.AmbientLight(0x223344,1.2));
const sun=new THREE.DirectionalLight(0xffffff,1.0);
sun.position.set(5,3,5); scene.add(sun);
const fill=new THREE.DirectionalLight(0x112244,0.4);
fill.position.set(-5,-3,-5); scene.add(fill);

// Stars
const starGeo=new THREE.BufferGeometry();
const starPos=[];
for(let i=0;i<2000;i++){
  const theta=Math.random()*Math.PI*2; const phi=Math.acos(2*Math.random()-1);
  const r=50+Math.random()*100;
  starPos.push(r*Math.sin(phi)*Math.cos(theta),r*Math.cos(phi),r*Math.sin(phi)*Math.sin(theta));
}
starGeo.setAttribute('position',new THREE.Float32BufferAttribute(starPos,3));
scene.add(new THREE.Points(starGeo,new THREE.PointsMaterial({color:0x445566,size:0.15})));

// ‚îÄ‚îÄ HOTSPOT DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOTSPOTS=[
  {lat:31.5,lon:34.8,label:'GAZA/ISRAEL',sev:'critical',type:'conflict',
   title:'Gaza ‚Äî Active Conflict Zone',
   body:'Ongoing operations. Regional escalation risk involves Hezbollah and IRGC. Iran-backed proxy involvement continues.',
   mkt:'WTI Crude (CL=F), XLE, ITA',tags:['OIL RISK','ESCALATION']},
  {lat:14,lon:43,label:'RED SEA',sev:'critical',type:'shipping',
   title:'Red Sea ‚Äî Houthi Shipping Attacks',
   body:'Houthi attacks on commercial vessels ongoing. Ships rerouting around Cape of Good Hope (+12-14 days voyage time).',
   mkt:'Container rates, XLE, European CPI',tags:['SHIPPING','INFLATION']},
  {lat:26.5,lon:56,label:'HORMUZ',sev:'elevated',type:'energy',
   title:'Strait of Hormuz ‚Äî Iranian Naval Presence',
   body:'IRGC elevated naval presence. 20% of global oil transits here. Lloyd\'s war risk premium elevated.',
   mkt:'WTI (CL=F), Brent, XLE, Airline margins',tags:['20% GLOBAL OIL','IRAN']},
  {lat:25,lon:121,label:'TAIWAN',sev:'elevated',type:'trade',
   title:'Taiwan Strait ‚Äî PLA Military Posture',
   body:'PLA conducting regular exercises. TSMC produces 90% of advanced chips. US carrier groups present.',
   mkt:'SMH, NVDA, AAPL supply chain, SOXX',tags:['TSMC','SEMICONDUCTORS']},
  {lat:49,lon:31,label:'UKRAINE',sev:'critical',type:'conflict',
   title:'Ukraine ‚Äî Active War Theater',
   body:'Frontline active. Russia targeting energy infrastructure. NATO posture elevated.',
   mkt:'Natural gas (NG=F), Wheat (ZW=F), European banks',tags:['NATGAS','GRAIN']},
  {lat:14,lon:2,label:'SAHEL',sev:'elevated',type:'minerals',
   title:'Sahel ‚Äî Coups & Critical Minerals',
   body:'Coup governments across Mali, Niger, Burkina Faso. Chinese mining rights expanding.',
   mkt:'GDX, SIL, LIT (lithium ETF)',tags:['GOLD','LITHIUM']},
  {lat:-5,lon:23.5,label:'DRC/COBALT',sev:'elevated',type:'minerals',
   title:'DRC ‚Äî Cobalt Supply Chain',
   body:'DRC produces ~70% of world cobalt. Eastern DRC conflict threatening mining operations.',
   mkt:'Cobalt, TSLA supply chain, ALB, SQM',tags:['70% COBALT','EV']},
  {lat:12,lon:115,label:'S CHINA SEA',sev:'elevated',type:'shipping',
   title:'South China Sea ‚Äî Territorial Disputes',
   body:'$3T+ annual trade transits here. Philippines-China confrontations escalating.',
   mkt:'Container shipping, Asian FX, semiconductors',tags:['$3T TRADE','NAVAL']},
  {lat:56,lon:37.6,label:'RUSSIA',sev:'elevated',type:'energy',
   title:'Russia ‚Äî Energy Export Rerouting',
   body:'Russian oil rerouted to China and India. European LNG costs remain elevated.',
   mkt:'European natgas, LNG stocks, UNG, XLE',tags:['LNG','SANCTIONS']},
  {lat:35.6,lon:139.7,label:'BOJ/YEN',sev:'watch',type:'trade',
   title:'Japan ‚Äî BOJ Policy & Yen Carry Trade',
   body:'BOJ normalizing ultra-loose policy. Yen carry trade unwind risk ‚Äî trillions in positions.',
   mkt:'USD/JPY, Nikkei, DXY, global bonds',tags:['YEN CARRY','BOJ']},
  {lat:-20,lon:28,label:'ZIMBABWE',sev:'watch',type:'minerals',
   title:'Zimbabwe ‚Äî Lithium Export Controls',
   body:'Zimbabwe imposed raw lithium ore export ban. Chinese firms dominate processing.',
   mkt:'LIT, ALB (Albemarle), SQM',tags:['LITHIUM','EV']},
];

const COLORS={critical:'#FF4444',elevated:'#FF6600',watch:'#FFCC00'};
let customEvents=[]; let activeFilter='all';
let autoRotate=true; let dragging=false;
let prevX=0,prevY=0; let rotX=0,rotY=0;
let targetRotX=0,targetRotY=0;
let currentHotspot=null;
const markers=[];

function latLonToVec3(lat,lon,r=1.012){
  const phi=(90-lat)*Math.PI/180;
  const theta=(lon+180)*Math.PI/180;
  return new THREE.Vector3(
    -r*Math.sin(phi)*Math.cos(theta),
    r*Math.cos(phi),
    r*Math.sin(phi)*Math.sin(theta)
  );
}

function makeMarker(h){
  const col=COLORS[h.sev]||'#FF6600';
  const c=new THREE.Color(col);
  const geo=new THREE.SphereGeometry(0.016,12,12);
  const mat=new THREE.MeshBasicMaterial({color:c});
  const mesh=new THREE.Mesh(geo,mat);
  const pos=latLonToVec3(h.lat,h.lon);
  mesh.position.copy(pos);
  mesh.userData={hotspot:h};

  // Pulse ring
  const rg=new THREE.RingGeometry(0.022,0.028,24);
  const rm=new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:0.5,side:THREE.DoubleSide});
  const ring=new THREE.Mesh(rg,rm);
  ring.position.copy(pos);
  ring.lookAt(0,0,0); ring.rotateX(Math.PI/2);
  ring.userData={pulse:true,phase:Math.random()*Math.PI*2};
  scene.add(ring);
  scene.add(mesh);
  markers.push({mesh,ring,hotspot:h,basePos:pos.clone()});
  return mesh;
}

function renderMarkers(){
  // Remove old
  markers.forEach(({mesh,ring})=>{scene.remove(mesh);scene.remove(ring);});
  markers.length=0;
  const show=HOTSPOTS.filter(h=>activeFilter==='all'||h.type===activeFilter);
  if(activeFilter==='custom'||activeFilter==='all') customEvents.forEach(h=>show.push(h));
  show.forEach(makeMarker);
}
renderMarkers();

// ‚îÄ‚îÄ INTERACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('c');
const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();
let lastMouse={x:0,y:0};

function getMousePos(e){
  const r=canvas.getBoundingClientRect();
  return{x:e.clientX-r.left,y:e.clientY-r.top};
}

canvas.addEventListener('mousedown',e=>{
  dragging=true; autoRotate=false;
  const p=getMousePos(e); prevX=p.x; prevY=p.y;
});
canvas.addEventListener('mouseup',()=>{dragging=false;});
canvas.addEventListener('mousemove',e=>{
  const p=getMousePos(e);
  lastMouse={x:e.clientX,y:e.clientY};
  if(dragging){
    const dx=p.x-prevX; const dy=p.y-prevY;
    targetRotY+=dx*0.005; targetRotX+=dy*0.004;
    targetRotX=Math.max(-Math.PI/2.2,Math.min(Math.PI/2.2,targetRotX));
    prevX=p.x; prevY=p.y; autoRotate=false;
  }
  // Hover detection
  mouse.x=(p.x/W)*2-1; mouse.y=-(p.y/H)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(markers.map(m=>m.mesh));
  const tt=document.getElementById('tt');
  if(hits.length){
    const h=hits[0].object.userData.hotspot;
    tt.style.display='block';
    tt.style.left=(e.clientX+12)+'px';
    tt.style.top=(e.clientY-8)+'px';
    tt.textContent=h.label+' ‚Äî '+h.sev.toUpperCase();
    canvas.style.cursor='pointer';
  }else{
    tt.style.display='none';
    canvas.style.cursor='default';
  }
});
canvas.addEventListener('click',e=>{
  mouse.x=((e.clientX)/W)*2-1; mouse.y=-((e.clientY)/H)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(markers.map(m=>m.mesh));
  const ic=document.getElementById('ic');
  if(hits.length){
    const h=hits[0].object.userData.hotspot;
    showCard(h,e.clientX,e.clientY);
  }else{
    ic.style.display='none';
  }
});

function showCard(h,cx,cy){
  const ic=document.getElementById('ic');
  document.getElementById('ic-sev').textContent=h.sev.toUpperCase()+' ‚Äî '+h.type.toUpperCase();
  document.getElementById('ic-ttl').textContent=h.title||h.label;
  document.getElementById('ic-body').textContent=h.body||'';
  document.getElementById('ic-mkt').textContent=h.mkt?'üìä MARKET EXPOSURE: '+h.mkt:'';
  const tagsEl=document.getElementById('ic-tags');
  tagsEl.innerHTML=(h.tags||[]).map(t=>`<span class="ictag">${t}</span>`).join('');
  ic.className='show '+(h.sev||'elevated');
  // Position card
  let x=cx+18,y=cy-20;
  if(x+310>W) x=cx-325;
  if(y+220>H) y=H-230;
  ic.style.left=x+'px'; ic.style.top=y+'px';
  ic.style.display='block';
}

// Scroll zoom
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  camera.position.z+=e.deltaY*0.001;
  camera.position.z=Math.max(1.4,Math.min(5.0,camera.position.z));
},{passive:false});

// ‚îÄ‚îÄ THEATER FLY-TO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flyTo(lat,lon){
  const phi=(90-lat)*Math.PI/180;
  const theta=(lon+180)*Math.PI/180;
  targetRotY=theta-Math.PI;
  targetRotX=-(lat*Math.PI/180)*0.5;
  autoRotate=false;
}
window.flyTo=flyTo;

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFilter(f,btn){
  activeFilter=f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));
  if(btn) btn.classList.add('on');
  renderMarkers();
}
window.setFilter=setFilter;

// ‚îÄ‚îÄ ADD CUSTOM EVENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addCustomEvent(){
  const title=document.getElementById('ae-title').value;
  const lat=parseFloat(document.getElementById('ae-lat').value);
  const lon=parseFloat(document.getElementById('ae-lon').value);
  const desc=document.getElementById('ae-desc').value;
  const sev=document.getElementById('ae-sev').value;
  const mkt=document.getElementById('ae-mkt').value;
  if(!title||isNaN(lat)||isNaN(lon)) return;
  customEvents.push({lat,lon,label:title,sev,type:'custom',title,body:desc,mkt,tags:['CUSTOM']});
  document.getElementById('adddlg').classList.remove('show');
  renderMarkers();
}
window.addCustomEvent=addCustomEvent;

// ‚îÄ‚îÄ ANIMATION LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastT=0;
function animate(t){
  requestAnimationFrame(animate);
  const dt=Math.min((t-lastT)/1000,0.05); lastT=t;

  if(autoRotate) targetRotY+=dt*0.08;

  rotX+=(targetRotX-rotX)*0.08;
  rotY+=(targetRotY-rotY)*0.08;

  if(globeMesh){
    globeMesh.rotation.x=rotX;
    globeMesh.rotation.y=rotY;
  }
  scene.children.forEach(obj=>{
    if(obj.userData.pulse!==undefined&&!obj.userData.hotspot){return;}
  });
  // Rotate markers with globe
  markers.forEach(({mesh,ring,hotspot,basePos})=>{
    const euler=new THREE.Euler(rotX,rotY,0,'XYZ');
    const quat=new THREE.Quaternion().setFromEuler(euler);
    const rotated=basePos.clone().applyQuaternion(quat);
    mesh.position.copy(rotated);
    ring.position.copy(rotated);
    ring.lookAt(camera.position);
    // Pulse
    const p=ring.userData.phase||0;
    ring.userData.phase=(p||0)+dt*2;
    ring.material.opacity=0.3+0.25*Math.sin(ring.userData.phase);
    const scl=1+0.15*Math.sin(ring.userData.phase);
    ring.scale.set(scl,scl,1);
    // Hide markers on back of globe
    const toCamera=camera.position.clone().sub(rotated).normalize();
    const normal=rotated.clone().normalize();
    mesh.visible=toCamera.dot(normal)>0.1;
    ring.visible=toCamera.dot(normal)>0.1;
  });

  renderer.render(scene,camera);
}
animate(0);

// Resize
window.addEventListener('resize',()=>{
  const w=window.innerWidth,h=window.innerHeight;
  camera.aspect=w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h);
});
</script>
</body>
</html>
